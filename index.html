<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0e27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>JRVendI Pro - Sistema Premium</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>


    /* --- DEFINIﾃﾃグ DE PLUGINS (ADICIONE ISTO NO TOPO) --- */
    const CapacitorObj = (typeof Capacitor !== 'undefined') ? Capacitor : null;
    const Plugins = CapacitorObj ? CapacitorObj.Plugins : {};
    const GoogleAuth = Plugins.GoogleAuth || null;

    // --- CONFIGURAﾃﾃグ FIREBASE (Mantenha o seu cﾃｳdigo original abaixo) ---
    const firebaseConfig = { ...

    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@aspect-build/aspect-build-rules-js@1.0.0/js/private/zxing.min.js" onerror="console.log('ZXing fallback')"></script>
    <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>

    <style>
    /* --- ESTILO DO MODAL DE SUCESSO DA VENDA --- */
.success-actions-modal {
    text-align: center;
}

.success-icon-large {
    font-size: 4rem;
    color: var(--success);
    margin-bottom: 15px;
    animation: successPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.action-btn-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 25px;
    width: 100%;
}

.btn-action-large {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 16px;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: transform 0.2s;
    width: 100%;
}



.btn-action-large:active {
    transform: scale(0.98);
}

.btn-pdf {
    background: var(--brand); /* Laranja do seu tema */
    color: white;
    box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
}

.btn-whatsapp {
    background: #25D366; /* Verde Oficial WhatsApp */
    color: white;
    box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
}

.btn-close-simple {
    background: var(--card-light);
    color: var(--text-muted);
    border: 1px solid var(--border-color);
}

        :root {
            --bg-dark: #0a0e27;
            --bg-secondary: #111633;
            --card-dark: #1a1f3a;
            --card-light: #252d4a;
            --input-bg: #1f2640;
            --border-color: #2d3a5c;
            --brand: #FF6600;
            --brand-hover: #e65c00;
            --brand-light: rgba(255, 102, 0, 0.1);
            --text-main: #ffffff;
            --text-muted: #a0aec0;
            --text-dark: #1a202c;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --pix: #32bcad;
            --radius: 16px;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%; width: 100%; overflow: hidden;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-secondary) 100%);
            color: var(--text-main);
            position: fixed; inset: 0;
        }

        /* SPLASH */
        #splash-screen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1f3a 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 99999; transition: opacity 0.5s ease;
        }

        .splash-logo {
            width: 120px; height: 120px;
            background: linear-gradient(135deg, var(--brand) 0%, #ff8c00 100%);
            border-radius: 30px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem; color: white; margin-bottom: 25px;
            box-shadow: 0 20px 60px rgba(255, 102, 0, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .splash-title {
            font-size: 2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--brand), #ff8c00);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 8px;
        }

        .splash-subtitle { color: var(--text-muted); font-size: 0.95rem; }

        .splash-loader {
            margin-top: 40px; width: 50px; height: 50px;
            border: 3px solid var(--border-color); border-top-color: var(--brand);
            border-radius: 50%; animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; inset: 0;
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-secondary) 100%);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9000; padding: 30px;
        }

        .login-logo {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, var(--brand), #ff8c00);
            border-radius: 25px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: white; margin-bottom: 25px;
            box-shadow: 0 15px 50px rgba(255, 102, 0, 0.4);
        }

        .login-title { font-size: 2rem; font-weight: 800; margin-bottom: 8px; }
        .login-subtitle { color: var(--text-muted); margin-bottom: 30px; text-align: center; }

        .login-card {
            background: var(--card-dark); border: 1px solid var(--border-color);
            border-radius: var(--radius); padding: 30px; width: 100%; max-width: 400px;
        }

        .google-btn {
            background: white; color: #333;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            padding: 14px; border-radius: 12px; font-weight: 600;
            cursor: pointer; border: none; width: 100%; font-size: 1rem; transition: 0.2s;
        }

        .google-btn:active { transform: scale(0.98); }
        .google-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .google-btn img { width: 24px; height: 24px; }

        /* APP */
        .app-container {
            display: none; flex-direction: column;
            height: 100%; width: 100%; position: relative;
            padding-top: var(--safe-top); padding-bottom: var(--safe-bottom);
        }

        /* HEADER */
        header {
            background: linear-gradient(135deg, var(--card-dark) 0%, var(--card-light) 100%);
            padding: 15px 20px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100; flex-shrink: 0;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }

        .btn-back {
            background: none; border: none; color: var(--text-main);
            font-size: 1.3rem; cursor: pointer; padding: 8px; display: none;
        }

        .header-title {
            font-size: 1.2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--brand) 0%, #ff8c00 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions { display: flex; gap: 8px; align-items: center; }

        .btn-icon {
            background: none; border: none; color: var(--text-main);
            font-size: 1.2rem; cursor: pointer; padding: 10px;
            border-radius: 50%; transition: 0.2s; position: relative;
        }

        .btn-icon:active { background: var(--brand-light); transform: scale(0.95); }

        .notification-badge {
            position: absolute; top: 5px; right: 5px;
            background: var(--danger); color: white;
            font-size: 0.65rem; font-weight: 700;
            padding: 2px 6px; border-radius: 10px; display: none;
        }

        /* MAIN */
        main {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 20px; padding-bottom: 100px;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: calc(70px + var(--safe-bottom)); padding-bottom: var(--safe-bottom);
            background: linear-gradient(135deg, var(--card-dark) 0%, var(--card-light) 100%);
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }

        .nav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            background: none; border: none; color: var(--text-muted);
            font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: 0.2s; padding: 8px 12px;
        }

        .nav-btn.active { color: var(--brand); }
        .nav-btn i { font-size: 1.4rem; }

        /* SCREENS */
        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .screen.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CARDS */
        .card {
            background: var(--card-dark); border: 1px solid var(--border-color);
            border-radius: var(--radius); padding: 20px; margin-bottom: 15px;
            box-shadow: var(--shadow); transition: 0.2s;
        }

        .card:active { transform: scale(0.98); }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 1.1rem; font-weight: 700; }

        /* BUTTONS */
        .btn {
            padding: 14px 20px; border: none; border-radius: var(--radius);
            font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s; font-size: 1rem; width: 100%; font-family: 'Poppins', sans-serif;
        }

        .btn:active { transform: scale(0.98); }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand) 0%, #ff8c00 100%);
            color: white; box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
        }

        .btn-secondary { background: var(--card-light); color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-pix { background: linear-gradient(135deg, var(--pix) 0%, #28a99a 100%); color: white; }
        .btn-small { padding: 10px 15px; font-size: 0.9rem; width: auto; }
        .btn-outline { background: transparent; border: 2px solid var(--brand); color: var(--brand); }

        /* INPUTS */
        .input-box, textarea, select {
            width: 100%; padding: 14px 16px;
            background: var(--input-bg); border: 1px solid var(--border-color);
            border-radius: 12px; color: var(--text-main);
            font-family: 'Poppins', sans-serif; font-size: 1rem;
            transition: 0.2s; margin-bottom: 12px; -webkit-appearance: none;
        }

        .input-box:focus, textarea:focus, select:focus {
            outline: none; border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.15);
        }

        .input-box::placeholder { color: var(--text-muted); }
        textarea { resize: vertical; min-height: 100px; }
        .input-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); }

        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal-box {
            background: var(--card-dark); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 30px; max-width: 450px; width: 100%;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            position: relative; animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-close {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; color: var(--text-muted);
            font-size: 1.5rem; cursor: pointer; padding: 5px;
        }

        .modal-title {
            font-size: 1.3rem; font-weight: 800; margin-bottom: 20px;
            color: var(--brand); text-align: center;
        }

        /* LIST ITEMS */
        .list-item {
            background: var(--card-light); border: 1px solid var(--border-color);
            border-radius: 14px; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 15px;
            transition: 0.2s; cursor: pointer;
        }

        .list-item:active { transform: scale(0.98); border-color: var(--brand); }

        .list-item-avatar {
            width: 50px; height: 50px; border-radius: 12px;
            background: var(--brand-light);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; color: var(--brand); flex-shrink: 0; overflow: hidden;
        }

        .list-item-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .list-item-info { flex: 1; min-width: 0; }
        .list-item-title { font-weight: 700; font-size: 1rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item-subtitle { color: var(--text-muted); font-size: 0.85rem; }
        .list-item-price { font-weight: 800; font-size: 1.1rem; color: var(--brand); }

        /* QUANTITY CONTROL */
        .quantity-control { display: flex; align-items: center; gap: 8px; background: var(--input-bg); border-radius: 10px; padding: 5px; }

        .quantity-btn {
            width: 36px; height: 36px; border: none; border-radius: 8px;
            background: var(--brand); color: white;
            font-size: 1.2rem; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }

        .quantity-btn:active { transform: scale(0.9); }
        .quantity-display { min-width: 40px; text-align: center; font-weight: 700; font-size: 1.1rem; }

        /* CART FLOAT */
        .cart-float {
            position: fixed; bottom: calc(80px + var(--safe-bottom));
            left: 20px; right: 20px;
            background: linear-gradient(135deg, var(--brand) 0%, #ff8c00 100%);
            padding: 15px 20px; border-radius: var(--radius);
            display: none; justify-content: space-between; align-items: center;
            z-index: 90; box-shadow: 0 10px 40px rgba(255, 102, 0, 0.4);
            animation: slideUp 0.3s ease-out;
        }

        .cart-float.active { display: flex; }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .cart-info { color: white; }
        .cart-info-count { font-weight: 800; font-size: 1.1rem; }
        .cart-info-total { font-size: 0.9rem; opacity: 0.9; }

        .cart-float-btn {
            background: white; color: var(--brand);
            padding: 10px 20px; border: none; border-radius: 10px;
            font-weight: 700; cursor: pointer;
        }

        /* BADGES */
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: var(--info); }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }

        .grid-item {
            background: var(--card-light); border: 1px solid var(--border-color);
            border-radius: var(--radius); padding: 20px 15px;
            text-align: center; cursor: pointer; transition: 0.2s;
        }

        .grid-item:active { transform: scale(0.95); border-color: var(--brand); }
        .grid-item i { font-size: 2rem; color: var(--brand); margin-bottom: 10px; }
        .grid-item-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; }
        .grid-item-subtitle { font-size: 0.8rem; color: var(--text-muted); }

        /* STATS */
        .stats-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }

        .stat-card { background: var(--card-light); border: 1px solid var(--border-color); border-radius: 14px; padding: 15px; }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .stat-value { font-size: 1.4rem; font-weight: 800; }
        .stat-value.success { color: var(--success); }
        .stat-value.danger { color: var(--danger); }
        .stat-value.info { color: var(--info); }

        /* TOAST */
        #toast-container {
            position: fixed; top: calc(20px + var(--safe-top)); right: 20px;
            z-index: 99999; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; max-width: 90vw;
        }

        .toast {
            background: white; padding: 15px 20px; border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex; align-items: center; gap: 12px;
            pointer-events: auto; animation: toastIn 0.3s ease-out; min-width: 280px;
        }

        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; flex-shrink: 0;
        }

        .toast-icon.success { background: #d1fae5; color: var(--success); }
        .toast-icon.error { background: #fee2e2; color: var(--danger); }
        .toast-icon.warning { background: #fef3c7; color: var(--warning); }
        .toast-icon.info { background: #dbeafe; color: var(--info); }

        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; color: var(--text-dark); font-size: 0.95rem; }
        .toast-message { color: #666; font-size: 0.85rem; margin-top: 2px; }

        /* PREMIUM CARD */
        .premium-card {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border: none; padding: 20px; border-radius: var(--radius); margin-bottom: 20px;
        }

        .premium-card.expired { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); }
        .premium-card.trial { background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); }

        .premium-card-header { display: flex; justify-content: space-between; align-items: center; }
        .premium-card-title { font-size: 0.9rem; opacity: 0.9; }
        .premium-card-value { font-size: 1.3rem; font-weight: 800; margin-top: 5px; }
        .premium-card-icon { font-size: 2.5rem; opacity: 0.3; }

        /* IMAGE PREVIEW */
        .image-preview {
            width: 100%; height: 180px;
            background: var(--input-bg); border: 2px dashed var(--border-color);
            border-radius: 14px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 10px; margin-bottom: 15px; cursor: pointer; transition: 0.2s; overflow: hidden;
        }

        .image-preview:active { border-color: var(--brand); background: var(--brand-light); }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview-placeholder { color: var(--text-muted); text-align: center; }
        .image-preview-placeholder i { font-size: 2.5rem; margin-bottom: 10px; color: var(--brand); }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 4rem; opacity: 0.3; margin-bottom: 15px; }
        .empty-state p { font-size: 1rem; }

        /* PAYWALL */
        #paywall-modal {
            position: fixed; inset: 0;
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-secondary) 100%);
            z-index: 9999; display: none; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding: 30px; text-align: center; overflow-y: auto;
        }

        .paywall-header {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: 400px; margin-bottom: 20px;
        }

        .paywall-close-btn {
            background: var(--card-light); border: 1px solid var(--border-color);
            color: var(--text-main); padding: 10px 15px; border-radius: 10px;
            font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }

        .paywall-switch-btn {
            background: none; border: 1px solid var(--border-color);
            color: var(--text-muted); padding: 10px 15px; border-radius: 10px;
            font-size: 0.85rem; cursor: pointer;
        }

        .paywall-logo {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, var(--brand), #ff8c00);
            border-radius: 25px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: white; margin-bottom: 25px;
            box-shadow: 0 15px 50px rgba(255, 102, 0, 0.4);
        }

        .paywall-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; }
        .paywall-subtitle { color: var(--text-muted); margin-bottom: 30px; font-size: 1rem; }

        .plan-card {
            background: var(--card-dark); border: 2px solid var(--border-color);
            border-radius: var(--radius); padding: 20px; margin-bottom: 12px;
            width: 100%; max-width: 350px; cursor: pointer; transition: 0.2s;
        }

        .plan-card:active, .plan-card.selected { border-color: var(--brand); background: var(--brand-light); }
        .plan-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .plan-card-title { font-weight: 700; font-size: 1.1rem; }
        .plan-card-price { font-weight: 800; font-size: 1.3rem; color: var(--brand); }
        .plan-card-desc { color: var(--text-muted); font-size: 0.85rem; }

        /* PIX QR */
        .pix-qr-container { background: white; padding: 20px; border-radius: 16px; margin: 20px 0; }
        .pix-qr-container canvas { display: block; margin: 0 auto; }

        .pix-code-box {
            background: var(--input-bg); padding: 12px; border-radius: 10px;
            margin-top: 15px; word-break: break-all; font-size: 0.75rem;
            color: var(--text-muted); max-height: 80px; overflow-y: auto;
        }

        /* QR CODE COLETOR */
        .qr-coletor-container {
            background: white; padding: 25px; border-radius: 20px;
            margin: 20px 0; text-align: center;
        }

        .qr-coletor-container canvas { display: block; margin: 0 auto 15px; }
        .qr-coletor-code { font-size: 0.7rem; color: #666; word-break: break-all; padding: 10px; background: #f5f5f5; border-radius: 8px; }

        /* FILTER PILLS */
        .filter-pills { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; -webkit-overflow-scrolling: touch; }

        .filter-pill {
            padding: 8px 16px; background: var(--card-light);
            border: 1px solid var(--border-color); border-radius: 20px;
            font-size: 0.85rem; font-weight: 600; color: var(--text-muted);
            cursor: pointer; white-space: nowrap; transition: 0.2s;
        }

        .filter-pill.active { background: var(--brand); border-color: var(--brand); color: white; }

        /* SUCCESS SCREEN */
        .success-screen {
            position: fixed; inset: 0;
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-secondary) 100%);
            z-index: 99999; display: none; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 30px; text-align: center;
        }

        .success-icon {
            width: 120px; height: 120px;
            background: linear-gradient(135deg, var(--success), #059669);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 4rem; color: white; margin-bottom: 30px;
            animation: successPop 0.5s ease-out;
        }

        @keyframes successPop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .success-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; }
        .success-subtitle { color: var(--text-muted); margin-bottom: 30px; font-size: 1rem; }

        /* SCANNER OVERLAY */
        #scanner-overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }

        #scanner-overlay.active { display: flex; }

        .scanner-container { width: 100%; max-width: 400px; position: relative; }

        #scanner-video { width: 100%; border-radius: 20px; border: 3px solid var(--brand); }

        .scanner-frame {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 250px; height: 250px;
            border: 3px solid var(--brand);
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scanner-line {
            position: absolute; top: 0; left: 0; right: 0;
            height: 3px; background: var(--brand);
            animation: scanLine 2s linear infinite;
        }

        @keyframes scanLine { 0% { top: 0; } 50% { top: calc(100% - 3px); } 100% { top: 0; } }

        .scanner-close {
            position: absolute; top: 20px; right: 20px;
            background: var(--danger); color: white;
            border: none; border-radius: 50%;
            width: 50px; height: 50px;
            font-size: 1.5rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        .scanner-title {
            color: white; font-size: 1.2rem; font-weight: 700;
            margin-bottom: 20px; text-align: center;
        }

        /* CHECKOUT ITEM WITH DISCOUNT */
        .checkout-item {
            background: var(--card-light); border: 1px solid var(--border-color);
            border-radius: 14px; padding: 15px; margin-bottom: 12px;
        }

        .checkout-item-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 10px;
        }

        .checkout-item-name { font-weight: 700; font-size: 1rem; }
        .checkout-item-qty { color: var(--text-muted); font-size: 0.85rem; }

        .checkout-item-discount {
            display: flex; align-items: center; gap: 10px;
            padding-top: 10px; border-top: 1px solid var(--border-color);
        }

        .checkout-item-discount label { font-size: 0.85rem; color: var(--text-muted); }
        .checkout-item-discount input {
            width: 100px; padding: 8px; margin: 0;
            background: var(--input-bg); border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--text-main); font-size: 0.9rem;
        }

        .checkout-item-total {
            text-align: right; font-weight: 800; font-size: 1.1rem; color: var(--brand);
        }

        /* MESSAGE CARD EXPANDABLE */
        .message-card {
            background: var(--card-dark); border: 1px solid var(--border-color);
            border-radius: var(--radius); margin-bottom: 12px; overflow: hidden;
            transition: 0.3s;
        }

        .message-card-header {
            padding: 15px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }

        .message-card-header:active { background: var(--card-light); }

        .message-card-title { font-weight: 700; font-size: 1rem; }
        .message-card-meta { display: flex; align-items: center; gap: 10px; }
        .message-card-arrow { transition: 0.3s; color: var(--text-muted); }
        .message-card.expanded .message-card-arrow { transform: rotate(180deg); }

        .message-card-body {
            padding: 0 15px; max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .message-card.expanded .message-card-body {
            max-height: 500px; padding: 0 15px 15px;
        }

        .message-card-content {
            color: var(--text-muted); font-size: 0.9rem;
            line-height: 1.6; white-space: pre-wrap;
        }

        .message-card-content a { color: var(--brand); text-decoration: underline; }

        /* SUPPLIER ORDER */
        .supplier-item {
            background: var(--card-light); border: 1px solid var(--border-color);
            border-radius: 14px; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 15px;
        }

        .supplier-item-info { flex: 1; }
        .supplier-item-name { font-weight: 700; }
        .supplier-item-qty { color: var(--text-muted); font-size: 0.85rem; }

        .supplier-item-actions { display: flex; gap: 8px; }
        .supplier-item-actions button {
            width: 36px; height: 36px; border: none; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1rem;
        }

        /* LOAD MORE */
        .load-more-btn {
            background: var(--card-light); border: 1px solid var(--border-color);
            color: var(--brand); padding: 15px; border-radius: var(--radius);
            font-weight: 700; cursor: pointer; width: 100%; margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .load-more-btn:active { background: var(--brand-light); }

        /* TRIAL INFO BOX */
        .trial-info-box {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border: 1px solid var(--warning);
            border-radius: var(--radius); padding: 20px; margin-bottom: 20px;
        }

        .trial-info-box-title {
            font-weight: 700; color: var(--warning); margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px;
        }

        .trial-info-box-text { color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; }

        /* UTILITIES */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .gap-10 { gap: 10px; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

        /* TRIAL BANNER */
        .trial-banner {
            background: linear-gradient(135deg, var(--warning), #d97706);
            padding: 12px 20px; text-align: center;
            font-weight: 600; font-size: 0.9rem;
        }

        .trial-banner a { color: white; text-decoration: underline; }

        /* CPF ERROR BOX */
        .cpf-error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }

        .cpf-error-box p { color: var(--danger); font-size: 0.9rem; margin-bottom: 10px; }
    /* CORREﾃﾃグ DO VISUAL NCM E CEST */
.ncm-container { 
    position: relative; 
    width: 100%; 
    z-index: 1; /* Valor baixo padrﾃ｣o */
    transition: z-index 0.1s;
}

/* Mﾃ；ICA: Quando tocar no campo, ele vem para frente de tudo */
.ncm-container:focus-within {
    z-index: 1000; 
}

.ncm-suggestions {
    position: absolute; 
    top: 100%; 
    left: 0; 
    right: 0;
    background: var(--card-light); 
    border: 1px solid var(--brand); 
    border-radius: 0 0 12px 12px; 
    max-height: 250px; 
    overflow-y: auto;
    z-index: 1001; /* Garante que a lista fique acima */
    display: none; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
}

.ncm-suggestions.active { display: block; }

.ncm-item {
    padding: 12px 15px; 
    border-bottom: 1px solid var(--border-color);
    font-size: 0.85rem; 
    color: var(--text-muted); 
    cursor: pointer;
    background: var(--card-light);
}

.ncm-item:hover, .ncm-item:active { 
    background: var(--brand); 
    color: white; 
}

.ncm-item:hover strong, .ncm-item:active strong { color: white; }
/* --- ESTILO DO NOVO MODAL DE SUCESSO --- */
.success-modal-content {
    text-align: center;
    padding: 10px;
}

.success-icon-large {
    font-size: 4.5rem;
    color: var(--success);
    margin-bottom: 15px;
    animation: successPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.success-actions {
    display: flex;
    flex-direction: column;
    gap: 12px; /* Espaﾃｧo entre os botﾃｵes */
    margin-top: 25px;
    width: 100%;
}

.btn-action-big {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 16px;
    border-radius: 14px;
    font-size: 1rem;
    font-weight: 700;
    border: none;
    cursor: pointer;
    width: 100%;
    color: white;
    transition: transform 0.2s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}
/* --- CORREﾃﾃグ DO CPF NA FRENTE DO PAYWALL --- */
#modal-cpf {
    z-index: 10002 !important; /* Maior que o Paywall (9999) */
    background: rgba(0, 0, 0, 0.85); /* Fundo escuro para destacar */
}


.btn-action-big:active { transform: scale(0.97); }

.btn-pdf-action { background: linear-gradient(135deg, var(--brand) 0%, #ff8c00 100%); }
.btn-zap-action { background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); }
.btn-close-action { 
    background: var(--card-light); 
    color: var(--text-muted); 
    border: 1px solid var(--border-color);
    margin-top: 10px;
}
/* --- ESTILO GRID DE VENDAS (CARTﾃ髭S) --- */
.products-grid-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 Colunas */
    gap: 15px;
    padding-bottom: 20px;
}

.product-card-sale {
    background: var(--card-light);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    transition: 0.2s;
    height: 100%;
}

.product-card-sale:active {
    transform: scale(0.97);
    border-color: var(--brand);
}

.card-img-box {
    width: 100%;
    height: 100px;
    background: var(--bg-dark);
    border-radius: 12px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.card-img-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-img-box i {
    font-size: 2.5rem;
    color: var(--text-muted);
    opacity: 0.5;
}

.card-title-sale {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 4px;
    line-height: 1.3;
    height: 36px; /* Limita altura para alinhar */
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    width: 100%;
}

.card-stock-sale {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.card-price-sale {
    font-weight: 800;
    font-size: 1.2rem; /* Valor bem visﾃｭvel */
    color: var(--brand);
    margin-bottom: 12px;
}

/* Botﾃ｣o de Adicionar (Largo) */
.btn-add-grid {
    width: 100%;
    padding: 10px;
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    margin-top: auto; /* Empurra para baixo */
}

/* Controle de Quantidade no Grid */
.grid-qty-control {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--bg-dark);
    border-radius: 10px;
    width: 100%;
    padding: 5px;
    margin-top: auto;
    border: 1px solid var(--brand);
}

.btn-qty-grid {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: none;
    background: var(--card-light);
    color: white;
    font-weight: bold;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
}
/* --- CORREﾃﾃグ: ALERTA DE CONFIRMAﾃﾃグ NA FRENTE DE TUDO --- */
#modal-universal-confirm {
    z-index: 10005 !important; /* Forﾃｧa ficar acima do menu de usuﾃ｡rio */
    background: rgba(0, 0, 0, 0.9); /* Fundo um pouco mais escuro para destaque */
}
/* ESTILO NOVO PARA A LISTA NCM COM EXPANSﾃグ */
.ncm-item-wrapper {
    border-bottom: 1px solid var(--border-color);
    background: var(--card-light);
}

.ncm-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    cursor: pointer;
}

.ncm-row:hover {
    background: rgba(255, 102, 0, 0.05); /* Leve toque laranja */
}

.ncm-main-info {
    flex: 1;
}

.ncm-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-expand-ncm {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--brand);
    width: 32px; 
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.2s;
}

.btn-expand-ncm:hover {
    background: var(--brand);
    color: white;
}

.ncm-full-details {
    display: none; /* Escondido por padrﾃ｣o */
    padding: 10px 15px 15px 15px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px dashed var(--border-color);
    font-size: 0.8rem;
    color: var(--text-muted);
}

.ncm-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 8px;
}

.ncm-detail-item strong {
    color: var(--text-main);
    display: block;
    font-size: 0.75rem;
}
/* CORREﾃﾃグ: Garante que a lista fique sobre o campo CEST ao clicar no olho */
.ncm-container.searching {
    z-index: 10005 !important; /* Maior que tudo */
}

/* Garante fundo sﾃｳlido para nﾃ｣o ver o texto de baixo */
.ncm-suggestions {
    background-color: var(--card-dark) !important; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.9);
}
/* --- ADICIONE ISTO NO SEU CSS (Dentro da tag <style>) --- */

/* Isso garante que o botﾃ｣o especﾃｭfico da tela de vendas tenha espaﾃｧo 
   suficiente para nﾃ｣o ficar atrﾃ｡s do carrinho flutuante */
#load-more-sales-btn {
    margin-bottom: 140px !important; 
    position: relative;
    z-index: 5;
}


    </style>
</head>
<body>

    <!-- SPLASH -->
    <div id="splash-screen">
        <div class="splash-logo"><i class="fas fa-fire"></i></div>
        <div class="splash-title">JRVendI Pro</div>
        <div class="splash-subtitle">Sistema Premium de Gestﾃ｣o</div>
        <div class="splash-loader"></div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-logo"><i class="fas fa-fire"></i></div>
        <div class="login-title">JRVendI Pro</div>
        <div class="login-subtitle">Sistema Premium de Gestﾃ｣o de Vendas<br><span style="color: var(--success);">笨ｨ 7 dias grﾃ｡tis para novos usuﾃ｡rios!</span></div>

        <div class="login-card">
            <div class="mb-20">
                <label class="input-label">CPF (Obrigatﾃｳrio)</label>
                <input type="tel" id="login-cpf" class="input-box" placeholder="000.000.000-00" maxlength="14" oninput="maskCPF(this)">
            </div>

            <button class="google-btn" id="google-btn" onclick="loginWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                <span id="google-btn-text">Entrar com Google</span>
            </button>

            <p style="color: var(--text-muted); font-size: 0.8rem; text-align: center; margin-top: 15px;">
                Ao entrar, vocﾃｪ concorda com os termos de uso.
            </p>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast-container"></div>

    <!-- SCANNER OVERLAY -->
    <div id="scanner-overlay">
        <button class="scanner-close" onclick="closeScanner()"><i class="fas fa-times"></i></button>
        <div class="scanner-title" id="scanner-title">Escaneie o cﾃｳdigo de barras</div>
        <div class="scanner-container">
            <video id="scanner-video" autoplay playsinline></video>
            <div class="scanner-frame">
                <div class="scanner-line"></div>
            </div>
        </div>
        <p style="color: var(--text-muted); margin-top: 20px; text-align: center;">
            Posicione o cﾃｳdigo dentro da ﾃ｡rea
        </p>
    </div>

    <!-- APP -->
    <div class="app-container" id="app-container">
        <!-- TRIAL BANNER -->
        <div class="trial-banner" id="trial-banner" style="display: none;">
            <i class="fas fa-clock"></i> Perﾃｭodo de teste: <span id="trial-days-left">7</span> dias restantes.
            <a href="#" onclick="showPaywall()">Assinar agora</a>
        </div>

        <header>
            <div class="header-left">
                <button class="btn-back" id="btn-back" onclick="handleBackButton()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="header-title"><i class="fas fa-fire"></i> JRVendI Pro</div>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="openScreen('messages-screen')" title="Mensagens">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notification-badge">0</span>
                </button>
                <button class="btn-icon" onclick="openUserMenu()" title="Perfil">
                    <i class="fas fa-user-circle"></i>
                </button>
            </div>
        </header>

        <main id="main-content">
            <!-- HOME -->
            <div id="home-screen" class="screen active">
                <div id="premium-status-card" class="premium-card">
                    <div class="premium-card-header">
                        <div>
                            <div class="premium-card-title">Status da Conta</div>
                            <div class="premium-card-value" id="premium-status-text">Verificando...</div>
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 5px;">
                                Vﾃ｡lido atﾃｩ: <span id="premium-until">--/--/----</span>
                            </div>
                        </div>
                        <div class="premium-card-icon"><i class="fas fa-crown"></i></div>
                    </div>
                </div>

                <div class="grid">
                    <div class="grid-item" onclick="openScreen('sales-screen')">
                        <i class="fas fa-shopping-cart"></i>
                        <div class="grid-item-title">Vendas</div>
                        <div class="grid-item-subtitle">PDV Rﾃ｡pido</div>
                    </div>
                    <div class="grid-item" onclick="openScreen('products-screen')">
                        <i class="fas fa-box"></i>
                        <div class="grid-item-title">Produtos</div>
                        <div class="grid-item-subtitle">Gerenciar</div>
                    </div>
                    <div class="grid-item" onclick="openScreen('clients-screen')">
                        <i class="fas fa-users"></i>
                        <div class="grid-item-title">Clientes</div>
                        <div class="grid-item-subtitle">Cadastros</div>
                    </div>
                    <div class="grid-item" onclick="openScreen('report-screen')">
                        <i class="fas fa-chart-line"></i>
                        <div class="grid-item-title">Relatﾃｳrios</div>
                        <div class="grid-item-subtitle">Anﾃ｡lises</div>
                    </div>
                    <div class="grid-item" onclick="openScreen('waitlist-screen')">
                        <i class="fas fa-clock"></i>
                        <div class="grid-item-title">Espera</div>
                        <div class="grid-item-subtitle">Pendentes</div>
                    </div>
                    <div class="grid-item" onclick="openScreen('supplier-screen')">
                        <i class="fas fa-truck"></i>
                        <div class="grid-item-title">Pedidos</div>
                        <div class="grid-item-subtitle">Fornecedor</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ﾃ嗟timas Vendas</div>
                        <button class="btn btn-small btn-outline" onclick="openScreen('history-screen')">Ver Todas</button>
                    </div>
                    <div id="recent-sales-list"></div>
                </div>
            </div>

            <!-- SALES -->
            <div id="sales-screen" class="screen">
                <div class="flex-between mb-20">
                    <input type="text" id="search-products" class="input-box" placeholder="剥 Buscar produto..." oninput="searchProducts()" style="margin-bottom: 0; flex: 1;">
                    <button class="btn btn-primary btn-small" onclick="openScanner('sales')" style="margin-left: 10px; width: auto;">
                        <i class="fas fa-barcode"></i>
                    </button>
                </div>
                <div id="products-for-sale"></div>
             <button class="load-more-btn" id="load-more-sales-btn" onclick="loadMoreProductsForSale()" style="display: none;">
    <i class="fas fa-plus"></i> Carregar mais produtos
</button>

<div style="height: 160px; width: 100%; clear: both;"></div>

            </div>

            <!-- PRODUCTS -->
            <div id="products-screen" class="screen">
                <div class="flex-between mb-20">
                    <h2 style="font-size: 1.3rem;">Produtos</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-small" onclick="openScanner('product')" style="width: auto;">
                            <i class="fas fa-barcode"></i>
                        </button>
                        <button class="btn btn-primary btn-small" onclick="openAddProductModal()" style="width: auto;">
                            <i class="fas fa-plus"></i> Novo
                        </button>
                    </div>
                </div>
                <div id="products-list"></div>
                <button class="load-more-btn" id="load-more-products-btn" onclick="loadMoreProducts()" style="display: none;">
                    <i class="fas fa-plus"></i> Carregar mais produtos
                </button>
            </div>

            <!-- CLIENTS -->
            <div id="clients-screen" class="screen">
                <div class="flex-between mb-20">
                    <h2 style="font-size: 1.3rem;">Clientes</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-small" onclick="addClientFromContacts()" style="width: auto;">
                            <i class="fas fa-address-book"></i>
                        </button>
                        <button class="btn btn-primary btn-small" onclick="openAddClientModal()" style="width: auto;">
                            <i class="fas fa-plus"></i> Novo
                        </button>
                    </div>
                </div>
                <div id="clients-list"></div>
            </div>

            <!-- CHECKOUT -->
            <div id="checkout-screen" class="screen">
                <div class="flex-between mb-20">
                    <h2 style="font-size: 1.3rem;">Finalizar Venda</h2>
                    <button class="btn btn-danger btn-small" onclick="cancelSale()" style="width: auto;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
                <div id="checkout-items"></div>
                <div class="card">
                    <div class="flex-between mb-10" style="padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                        <span>Subtotal:</span>
                        <span id="checkout-subtotal" style="font-weight: 700;">R$ 0,00</span>
                    </div>
                    <div class="flex-between mb-10">
                        <span>Descontos:</span>
                        <span id="checkout-discounts" style="font-weight: 700; color: var(--danger);">- R$ 0,00</span>
                    </div>
                    <div class="flex-between mb-20" style="padding-top: 10px; border-top: 2px solid var(--brand);">
                        <span style="font-weight: 700; font-size: 1.1rem;">Total:</span>
                        <span id="checkout-total" style="font-weight: 800; font-size: 1.4rem; color: var(--brand);">R$ 0,00</span>
                    </div>
                    <div class="mb-20">
                        <label class="input-label">Forma de Pagamento</label>
                        <select id="payment-method" class="input-box" style="margin-bottom: 0;">
                            <option value="Dinheiro">跳 Dinheiro</option>
                            <option value="Pix">泙 Pix</option>
                            <option value="Cartﾃ｣o">諜 Cartﾃ｣o</option>
                            <option value="Crﾃｩdito">投 Crﾃｩdito</option>
                        </select>
                    </div>
                    <button class="btn btn-success mb-10" onclick="showConfirmSaleModal()">
                        <i class="fas fa-check"></i> Confirmar Venda
                    </button>
                    <button class="btn btn-secondary" onclick="saveToWaitlist()">
                        <i class="fas fa-clock"></i> Colocar em Espera
                    </button>
                </div>
            </div>

            <!-- WAITLIST -->
            <div id="waitlist-screen" class="screen">
                <h2 style="font-size: 1.3rem; margin-bottom: 20px;">Vendas em Espera</h2>
                <div id="waitlist-items"></div>
            </div>

            <!-- SUPPLIER ORDERS -->
            <div id="supplier-screen" class="screen">
                <div class="flex-between mb-20">
                    <h2 style="font-size: 1.3rem;">Pedidos Fornecedor</h2>
                    <button class="btn btn-primary btn-small" onclick="openAddSupplierItemModal()" style="width: auto;">
                        <i class="fas fa-plus"></i> Adicionar
                    </button>
                </div>
                <div id="supplier-list"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="exportSupplierPDF()" style="flex: 1;">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-success" onclick="shareSupplierWhatsApp()" style="flex: 1;">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                </div>
            </div>

            <!-- REPORT -->
            <div id="report-screen" class="screen">
                <h2 style="font-size: 1.3rem; margin-bottom: 20px;">Relatﾃｳrios</h2>
                <div class="filter-pills">
                    <button class="filter-pill active" onclick="filterReport('today', this)">Hoje</button>
                    <button class="filter-pill" onclick="filterReport('week', this)">Semana</button>
                    <button class="filter-pill" onclick="filterReport('month', this)">Mﾃｪs</button>
                    <button class="filter-pill" onclick="filterReport('all', this)">Todos</button>
                </div>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-label">Total Vendas</div>
                        <div class="stat-value success" id="report-total-sales">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Gastos</div>
                        <div class="stat-value danger" id="report-total-expenses">R$ 0,00</div>
                    </div>
                </div>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-label">Lucro Lﾃｭquido</div>
                        <div class="stat-value info" id="report-profit">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Transaﾃｧﾃｵes</div>
                        <div class="stat-value" id="report-transactions">0</div>
                    </div>
                </div>
                <div class="card">
                    <div style="height: 220px;">
                        <canvas id="sales-chart"></canvas>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="exportReportPDF()" style="flex: 1;">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-success" onclick="shareReportWhatsApp()" style="flex: 1;">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                </div>
            </div>

            <!-- HISTORY -->
            <div id="history-screen" class="screen">
                <h2 style="font-size: 1.3rem; margin-bottom: 20px;">Histﾃｳrico</h2>
                <div class="filter-pills">
                    <button class="filter-pill active" onclick="filterHistory('today', this)">Hoje</button>
                    <button class="filter-pill" onclick="filterHistory('week', this)">Semana</button>
                    <button class="filter-pill" onclick="filterHistory('month', this)">Mﾃｪs</button>
                    <button class="filter-pill" onclick="filterHistory('all', this)">Todos</button>
                </div>
                <div id="history-list"></div>
            </div>

            <!-- MESSAGES -->
            <div id="messages-screen" class="screen">
                <h2 style="font-size: 1.3rem; margin-bottom: 20px;">Mensagens do Sistema</h2>
                <div id="messages-list"></div>
            </div>

            <!-- SETTINGS -->
            <div id="settings-screen" class="screen">
                <h2 style="font-size: 1.3rem; margin-bottom: 20px;">Configuraﾃｧﾃｵes</h2>

                <!-- TRIAL INFO BOX -->
                <div class="trial-info-box" id="trial-settings-box" style="display: none;">
                    <div class="trial-info-box-title">
                        <i class="fas fa-clock"></i> Perﾃｭodo de Teste
                    </div>
                    <div class="trial-info-box-text">
                        Vocﾃｪ estﾃ｡ utilizando o <strong>perﾃｭodo de teste gratuito de 7 dias</strong>. Durante este perﾃｭodo, vocﾃｪ tem acesso a todas as funcionalidades do sistema. Apﾃｳs o tﾃｩrmino, serﾃ｡ necessﾃ｡rio assinar um plano para continuar usando.
                        <br><br>
                        <strong>Dias restantes:</strong> <span id="trial-days-settings">0</span>
                    </div>
                </div>

                <div class="card" onclick="openScreen('store-settings-screen')">
                    <div class="flex-between">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: var(--brand-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--brand); font-size: 1.2rem;">
                                <i class="fas fa-store"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700;">Informaﾃｧﾃｵes da Loja</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Nome, CNPJ, rodapﾃｩ</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>

                <div class="card" onclick="openColetorScreen()">
                    <div class="flex-between">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--info); font-size: 1.2rem;">
                                <i class="fas fa-barcode"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700;">Conectar Coletor</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">QR Code para vincular app</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>

                <div class="card" onclick="openExpensesScreen()">
                    <div class="flex-between">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: rgba(239, 68, 68, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--danger); font-size: 1.2rem;">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700;">Despesas</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Registrar gastos</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>

                <div class="card" onclick="showPaywall()">
                    <div class="flex-between">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--success); font-size: 1.2rem;">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700;">Comprar Plano</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Assinar Premium</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>

                <div class="card" onclick="logout()">
                    <div class="flex-between">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: rgba(239, 68, 68, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--danger); font-size: 1.2rem;">
                                <i class="fas fa-sign-out-alt"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--danger);">Sair da Conta</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Desconectar</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>
            </div>

            <!-- STORE SETTINGS -->
            <div id="store-settings-screen" class="screen">
                <h2 style="font-size: 1.3rem; margin-bottom: 20px;">Informaﾃｧﾃｵes da Loja</h2>
                <div class="card">
                    <div class="mb-20">
                        <label class="input-label">Nome da Loja</label>
                        <input type="text" id="store-name" class="input-box" placeholder="Minha Loja" style="margin-bottom: 0;">
                    </div>
                    <div class="mb-20">
                        <label class="input-label">CNPJ</label>
                        <input type="text" id="store-cnpj" class="input-box" placeholder="00.000.000/0000-00" maxlength="18" oninput="maskCNPJ(this)" style="margin-bottom: 0;">
                    </div>
                    <div class="mb-20">
                        <label class="input-label">Telefone</label>
                        <input type="tel" id="store-phone" class="input-box" placeholder="(00) 00000-0000" style="margin-bottom: 0;">
                    </div>
                    <div class="mb-20">
                        <label class="input-label">Endereﾃｧo</label>
                        <input type="text" id="store-address" class="input-box" placeholder="Rua, nﾃｺmero, bairro" style="margin-bottom: 0;">
                    </div>
                    <div class="mb-20">
                        <label class="input-label">Mensagem de Rodapﾃｩ (Comprovantes)</label>
                        <textarea id="store-footer" class="input-box" placeholder="Obrigado pela preferﾃｪncia! Volte sempre." style="margin-bottom: 0; min-height: 80px;"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveStoreSettings()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>

            <!-- COLETOR SCREEN -->
            <div id="coletor-screen" class="screen">
                <h2 style="font-size: 1.3rem; margin-bottom: 20px;">Conectar Coletor</h2>
                <div class="card" style="text-align: center;">
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Escaneie este QR Code no app <strong>JRVendI Coletor</strong> para conectar e gerenciar seus produtos.
                    </p>
                    <div class="qr-coletor-container">
                        <canvas id="coletor-qr-canvas" width="200" height="200"></canvas>
                        <div class="qr-coletor-code" id="coletor-uid-display">Carregando...</div>
                    </div>
                    <button class="btn btn-secondary" onclick="copyColetorCode()">
                        <i class="fas fa-copy"></i> Copiar Cﾃｳdigo
                    </button>
                    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 15px;">
                        <i class="fas fa-info-circle"></i> Este cﾃｳdigo ﾃｩ ﾃｺnico para sua conta
                    </p>
                </div>
            </div>

            <!-- EXPENSES -->
            <div id="expenses-screen" class="screen">
                <div class="flex-between mb-20">
                    <h2 style="font-size: 1.3rem;">Despesas</h2>
                    <button class="btn btn-primary btn-small" onclick="openAddExpenseModal()" style="width: auto;">
                        <i class="fas fa-plus"></i> Nova
                    </button>
                </div>
                <div class="stat-card mb-20" style="background: linear-gradient(135deg, var(--danger), #dc2626); border: none;">
                    <div class="stat-label" style="color: white; opacity: 0.9;">Total de Despesas</div>
                    <div class="stat-value" id="total-expenses-display" style="color: white;">R$ 0,00</div>
                </div>
                <div id="expenses-list"></div>
            </div>
        </main>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav">
            <button class="nav-btn active" id="nav-home" onclick="openScreen('home-screen')">
                <i class="fas fa-home"></i><span>Home</span>
            </button>
            <button class="nav-btn" id="nav-sales" onclick="openScreen('sales-screen')">
                <i class="fas fa-shopping-cart"></i><span>Vendas</span>
            </button>
            <button class="nav-btn" id="nav-products" onclick="openScreen('products-screen')">
                <i class="fas fa-box"></i><span>Produtos</span>
            </button>
            <button class="nav-btn" id="nav-report" onclick="openScreen('report-screen')">
                <i class="fas fa-chart-line"></i><span>Relatﾃｳrio</span>
            </button>
            <button class="nav-btn" id="nav-settings" onclick="openScreen('settings-screen')">
                <i class="fas fa-cog"></i><span>Config</span>
            </button>
        </div>

        <!-- CART FLOAT -->
        <div class="cart-float" id="cart-float">
            <div class="cart-info">
                <div class="cart-info-count"><span id="cart-count">0</span> itens</div>
                <div class="cart-info-total">R$ <span id="cart-total">0,00</span></div>
            </div>
            <button class="cart-float-btn" onclick="goToCheckout()">
                <i class="fas fa-arrow-right"></i> Finalizar
            </button>
        </div>
    </div>

    <!-- PAYWALL -->
    <div id="paywall-modal">
    <div class="paywall-header">
        <button class="paywall-close-btn" id="paywall-close-btn" onclick="closePaywall()" style="display: none;">
            <i class="fas fa-arrow-left"></i> Voltar
        </button>
        <button class="paywall-switch-btn" onclick="switchAccount()">
            <i class="fas fa-exchange-alt"></i> Trocar Conta
        </button>
    </div>

    <div class="paywall-logo"><i class="fas fa-lock"></i></div>
    <div class="paywall-title">Acesso Premium</div>
    <div class="paywall-subtitle">Escolha seu plano para continuar</div>

    <div class="plan-card" onclick="selectPlan(1, 19.99, this)">
        <div class="plan-card-header">
            <div class="plan-card-title">1 Mﾃｪs</div>
            <div class="plan-card-price">R$ 19,99</div>
        </div>
        <div class="plan-card-desc">Acesso completo por 30 dias</div>
    </div>

    <div class="plan-card" onclick="selectPlan(2, 39.99, this)">
        <div class="plan-card-header">
            <div class="plan-card-title">2 Meses</div>
            <div class="plan-card-price">R$ 39,99</div>
        </div>
        <div class="plan-card-desc">Economia garantida</div>
    </div>

    <div class="plan-card" onclick="selectPlan(3, 59.99, this)">
        <div class="plan-card-header">
            <div class="plan-card-title">3 Meses</div>
            <div class="plan-card-price">R$ 59,99</div>
        </div>
        <div class="plan-card-desc">Melhor custo-benefﾃｭcio (Trimestral)</div>
    </div>

    <button class="btn btn-pix mt-20" id="btn-generate-pix" onclick="generatePaymentPix()" style="max-width: 350px; display: none;">
        <i class="fab fa-pix"></i> Gerar QR Code Pix
    </button>
</div>



<div class="modal-overlay" id="modal-sale-success">
    <div class="modal-box">
        <div class="success-modal-content">
            <div class="success-icon-large">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="modal-title" style="font-size: 1.5rem; margin-bottom: 5px;">Venda Salva!</div>
            <div style="color: var(--text-muted); font-size: 0.9rem;">O que deseja fazer agora?</div>

            <div class="success-actions">
                <button class="btn-action-big btn-pdf-action" onclick="downloadCurrentPDF()">
                    <i class="fas fa-file-pdf" style="font-size: 1.4rem;"></i>
                    Baixar Comprovante
                </button>

                <button class="btn-action-big btn-zap-action" onclick="shareCurrentWhatsApp()">
                    <i class="fab fa-whatsapp" style="font-size: 1.5rem;"></i>
                    Enviar no WhatsApp
                </button>

                <button class="btn-action-big btn-close-action" onclick="finishAndClose()">
                    <i class="fas fa-times"></i>
                    Fechar / Nova Venda
                </button>
            </div>
        </div>
    </div>
</div>





    <!-- MODALS -->
    <div class="modal-overlay" id="modal-add-product">
    <div class="modal-box">
        <button class="modal-close" onclick="closeModal('modal-add-product')">ﾃ</button>
        <div class="modal-title">Adicionar/Editar Produto</div>
        <input type="hidden" id="editing-product-id">

        <div class="image-preview" id="product-image-preview" onclick="openImagePicker()">
            <div class="image-preview-placeholder">
                <i class="fas fa-camera"></i>
                <div>Toque para adicionar foto</div>
                <div style="font-size: 0.8rem;">Cﾃ｢mera ou Galeria</div>
            </div>
        </div>
        <input type="hidden" id="product-image-base64">
        
        <div class="ncm-container mb-20"> 
            <label class="input-label">Nome do Produto</label>
            <input type="text" id="product-name" class="input-box" placeholder="Ex: Salgadinho, Coca-Cola..." 
                   oninput="handleNameAndNcmSearch(this.value)" autocomplete="off" style="margin-bottom: 0;">
            <div class="ncm-suggestions" id="name-ncm-results"></div> 
        </div>

        <div class="ncm-container mb-20"> 
            <label class="input-label">CEST (Substituiﾃｧﾃ｣o Tributﾃ｡ria)</label>
            <input type="text" id="product-cest" class="input-box" placeholder="Ex: 03.001.00" 
                   oninput="handleCestSearch(this.value)" autocomplete="off" style="margin-bottom: 0;">
            <div class="ncm-suggestions" id="cest-results"></div> 
        </div>

        <input type="number" id="product-price" class="input-box" placeholder="Preﾃｧo (R$)" step="0.01" min="0">
        <input type="number" id="product-quantity" class="input-box" placeholder="Quantidade em estoque" step="1" min="0" value="1">

        <div class="mb-20">
            <label class="input-label">NCM (Fiscal)</label>
            <input type="text" id="product-ncm" class="input-box" placeholder="Cﾃｳdigo NCM serﾃ｡ preenchido..." readonly style="background-color: var(--card-light); opacity: 0.8;">
        </div>

        <div class="flex-between" style="gap: 10px;">
            <input type="text" id="product-sku" class="input-box" placeholder="Cﾃｳdigo de Barras" style="flex: 1; margin-bottom: 0;">
            <button class="btn btn-secondary btn-small" onclick="openScanner('sku')" style="width: auto; margin-bottom: 0;">
                <i class="fas fa-barcode"></i>
            </button>
        </div>
        
        <button class="btn btn-primary mt-20" onclick="saveProduct()">
            <i class="fas fa-save"></i> Salvar Produto
        </button>
    </div>
</div>

<div class="modal-overlay" id="modal-universal-confirm">
    <div class="modal-box" style="text-align: center; max-width: 380px;">
        <div id="confirm-icon-box" style="font-size: 3.5rem; margin-bottom: 20px; color: var(--warning);">
            <i id="confirm-icon-class" class="fas fa-exclamation-triangle"></i>
        </div>

        <div class="modal-title" id="confirm-title" style="margin-bottom: 10px;">Tem certeza?</div>
        <p id="confirm-message" style="color: var(--text-muted); margin-bottom: 25px; line-height: 1.5;">
            Essa aﾃｧﾃ｣o nﾃ｣o pode ser desfeita.
        </p>

        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeModal('modal-universal-confirm')" style="flex: 1;">
                Cancelar
            </button>
            <button id="btn-confirm-action" class="btn btn-danger" style="flex: 1;">
                Confirmar
            </button>
        </div>
    </div>
</div>









    <div class="modal-overlay" id="modal-add-client">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal('modal-add-client')">ﾃ</button>
            <div class="modal-title">Adicionar Cliente</div>
            <input type="text" id="client-name" class="input-box" placeholder="Nome do Cliente">
            <input type="tel" id="client-phone" class="input-box" placeholder="Telefone/WhatsApp">
            <input type="text" id="client-address" class="input-box" placeholder="Endereﾃｧo (opcional)">
            <button class="btn btn-primary" onclick="saveClient()">
                <i class="fas fa-save"></i> Salvar Cliente
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-add-expense">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal('modal-add-expense')">ﾃ</button>
            <div class="modal-title">Nova Despesa</div>
            <input type="text" id="expense-desc" class="input-box" placeholder="Descriﾃｧﾃ｣o">
            <input type="number" id="expense-value" class="input-box" placeholder="Valor (R$)" step="0.01" min="0">
            <select id="expense-category" class="input-box">
                <option value="Geral">Geral</option>
                <option value="Fornecedor">Fornecedor</option>
                <option value="Aluguel">Aluguel</option>
                <option value="Funcionﾃ｡rio">Funcionﾃ｡rio</option>
                <option value="Outros">Outros</option>
            </select>
            <button class="btn btn-primary" onclick="saveExpense()">
                <i class="fas fa-save"></i> Salvar Despesa
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-add-supplier-item">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal('modal-add-supplier-item')">ﾃ</button>
            <div class="modal-title">Adicionar ao Pedido</div>
            <input type="text" id="supplier-item-name" class="input-box" placeholder="Nome do Produto">
            <input type="number" id="supplier-item-qty" class="input-box" placeholder="Quantidade" step="1" min="1" value="1">
            <input type="text" id="supplier-item-obs" class="input-box" placeholder="Observaﾃｧﾃ｣o (opcional)">
            <button class="btn btn-primary" onclick="saveSupplierItem()">
                <i class="fas fa-plus"></i> Adicionar
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-confirm-sale">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal('modal-confirm-sale')">ﾃ</button>
            <div class="modal-title">Confirmar Venda</div>
            <div id="confirm-sale-summary"></div>
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 0.9rem; color: var(--text-muted);">Total a Pagar</div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--brand);" id="confirm-sale-total">R$ 0,00</div>
            </div>
            <button class="btn btn-success mb-10" onclick="completeSale()">
                <i class="fas fa-check-circle"></i> Confirmar e Finalizar
            </button>
            <button class="btn btn-secondary" onclick="closeModal('modal-confirm-sale')">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-pix">
        <div class="modal-box" style="text-align: center;">
            <button class="modal-close" onclick="closePixModal()">ﾃ</button>
            <div class="modal-title">Pagamento Pix</div>
            <div class="pix-qr-container">
                <canvas id="pix-qr-canvas" width="200" height="200"></canvas>
            </div>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                Escaneie o QR Code com seu app bancﾃ｡rio
            </p>
            <div class="pix-code-box" id="pix-code-text"></div>
            <button class="btn btn-secondary mt-20" onclick="copyPixCode()">
                <i class="fas fa-copy"></i> Copiar Cﾃｳdigo
            </button>
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 15px;">
                <i class="fas fa-circle-notch fa-spin"></i> Aguardando confirmaﾃｧﾃ｣o...
            </p>
        </div>
    </div>

    <div class="modal-overlay" id="modal-cpf">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal('modal-cpf')">ﾃ</button>
            <div class="modal-title">Informe seu CPF</div>
            
            <div class="cpf-error-box" id="cpf-error-box" style="display: none;">
                <p><i class="fas fa-exclamation-circle"></i> CPF invﾃ｡lido ou rejeitado pelo banco. Por favor, informe um CPF vﾃ｡lido.</p>
            </div>
            
            <p style="color: var(--text-muted); text-align: center; margin-bottom: 20px;">
                O CPF ﾃｩ necessﾃ｡rio para gerar o pagamento Pix
            </p>
            <input type="tel" id="cpf-input-field" class="input-box" placeholder="000.000.000-00" maxlength="14" oninput="maskCPF(this)">
            <button class="btn btn-primary" onclick="confirmCPF()">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-user-menu">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal('modal-user-menu')">ﾃ</button>
            <div class="modal-title">Minha Conta</div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 80px; height: 80px; background: var(--brand-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 2rem; color: var(--brand);">
                    <i class="fas fa-user"></i>
                </div>
                <div style="font-weight: 700; font-size: 1.1rem;" id="user-name">Usuﾃ｡rio</div>
                <div style="color: var(--text-muted); font-size: 0.9rem;" id="user-email">email@exemplo.com</div>
            </div>
            <div class="list-item mb-10" style="cursor: default;">
                <div class="list-item-avatar" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="list-item-info">
                    <div class="list-item-title">Status Premium</div>
                    <div class="list-item-subtitle" id="user-premium-status">Ativo atﾃｩ --/--/----</div>
                </div>
            </div>
            <button class="btn btn-danger mt-20" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sair da Conta
            </button>
        </div>
    </div>

    <!-- SUCCESS SCREEN -->
    <div class="success-screen" id="success-screen">
        <div class="success-icon"><i class="fas fa-check"></i></div>
        <div class="success-title">Pagamento Confirmado!</div>
        <div class="success-subtitle">Seu acesso Premium foi ativado</div>
        <div style="color: var(--text-muted); margin-bottom: 30px;">
            Vﾃ｡lido atﾃｩ: <span id="success-date" style="font-weight: 700; color: var(--success);">--/--/----</span>
        </div>
        <button class="btn btn-primary" onclick="closeSuccessScreen()" style="max-width: 300px;">
            <i class="fas fa-rocket"></i> Comeﾃｧar a Usar
        </button>
    </div>

    <!-- FILE INPUT -->
    <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">



    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA6QnTlb4VZzjGzCrlvT-38V-DCBywOee0",
            authDomain: "jrvendi-online.firebaseapp.com",
            projectId: "jrvendi-online",
            storageBucket: "jrvendi-online.firebasestorage.app",
            messagingSenderId: "422707332984",
            appId: "1:422707332984:web:d98f936a3ea044ed496a8d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        db.enablePersistence({ synchronizeTabs: true }).catch(err => console.warn("Persistﾃｪncia:", err.code));

        // Constants
        const MP_ACCESS_TOKEN = "APP_USR-2553991504320849-120919-48be5fc00eadd3b93524ae98f29644e9-3053194909";
        const PIX_KEY = '62986100910';
        const WHATSAPP_CONTACT = '5562982368265';
        const TRIAL_DAYS = 7;
        const PRODUCTS_PER_PAGE = 20;

        // Global Variables
        let currentUser = null;
        let products = [];
        let allProducts = [];
        let productsLoaded = 0;
        let hasMoreProducts = true;
        let clients = [];
        let sales = [];
        let expenses = [];
        let waitlist = [];
        let supplierOrders = [];
        let cart = [];
        let navigationHistory = [];
        let activeScreenId = 'home-screen';
        let selectedPlan = null;
        let currentPaymentId = null;
        let paymentCheckInterval = null;
        let salesChartInstance = null;
        let currentReportFilter = 'today';
        let storeSettings = {};
        let scannerMode = null;
        let codeReader = null;
        let isScanning = false;
        let isPremiumUser = false;
        let isTrialUser = false;
        let trialDaysLeft = 0;
        let canClosePaywall = false;

        // Utility Functions
        function maskCPF(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            if (value.length > 9) value = value.slice(0, 3) + '.' + value.slice(3, 6) + '.' + value.slice(6, 9) + '-' + value.slice(9);
            else if (value.length > 6) value = value.slice(0, 3) + '.' + value.slice(3, 6) + '.' + value.slice(6);
            else if (value.length > 3) value = value.slice(0, 3) + '.' + value.slice(3);
            input.value = value;
        }

        function maskCNPJ(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 14) value = value.slice(0, 14);
            if (value.length > 12) value = value.slice(0, 2) + '.' + value.slice(2, 5) + '.' + value.slice(5, 8) + '/' + value.slice(8, 12) + '-' + value.slice(12);
            else if (value.length > 8) value = value.slice(0, 2) + '.' + value.slice(2, 5) + '.' + value.slice(5, 8) + '/' + value.slice(8);
            else if (value.length > 5) value = value.slice(0, 2) + '.' + value.slice(2, 5) + '.' + value.slice(5);
            else if (value.length > 2) value = value.slice(0, 2) + '.' + value.slice(2);
            input.value = value;
        }

        function formatCurrency(value) {
            return parseFloat(value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            toast.innerHTML = `
                <div class="toast-icon ${type}"><i class="fas ${icons[type]}"></i></div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toastIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
        }

        // Navigation
        function openScreen(screenId, addToHistory = true) {
            if (activeScreenId === screenId) return;
            if (addToHistory && activeScreenId !== 'home-screen') navigationHistory.push(activeScreenId);
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            activeScreenId = screenId;

            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const navMap = { 'home-screen': 'nav-home', 'sales-screen': 'nav-sales', 'products-screen': 'nav-products', 'report-screen': 'nav-report', 'settings-screen': 'nav-settings' };
            if (navMap[screenId]) document.getElementById(navMap[screenId])?.classList.add('active');

            const btnBack = document.getElementById('btn-back');
            const mainScreens = ['home-screen', 'sales-screen', 'products-screen', 'report-screen', 'settings-screen'];
            btnBack.style.display = mainScreens.includes(screenId) ? 'none' : 'block';

            // Hide cart float when not on sales screen
            const cartFloat = document.getElementById('cart-float');
            if (screenId !== 'sales-screen') {
                cartFloat.classList.remove('active');
            } else if (cart.length > 0) {
                cartFloat.classList.add('active');
            }

            if (screenId === 'sales-screen') { productsLoaded = 0; searchProducts(); }
            if (screenId === 'products-screen') { productsLoaded = 0; renderProductsList(); }
            if (screenId === 'clients-screen') renderClientsList();
            if (screenId === 'report-screen') generateReport();
            if (screenId === 'history-screen') filterHistory('today');
            if (screenId === 'waitlist-screen') renderWaitlist();
            if (screenId === 'messages-screen') loadMessages();
            if (screenId === 'expenses-screen') renderExpensesList();
            if (screenId === 'home-screen') loadRecentSales();
            if (screenId === 'checkout-screen') updateCheckoutItems();
            if (screenId === 'coletor-screen') generateColetorQR();
            if (screenId === 'supplier-screen') renderSupplierList();
            if (screenId === 'settings-screen') updateTrialSettingsBox();

            document.getElementById('main-content').scrollTop = 0;
        }

        function goToCheckout() {
            openScreen('checkout-screen');
        }

        function handleBackButton() {
            const modals = ['modal-add-product', 'modal-add-client', 'modal-add-expense', 'modal-pix', 'modal-cpf', 'modal-user-menu', 'modal-confirm-sale', 'modal-add-supplier-item'];
            for (let id of modals) {
                const modal = document.getElementById(id);
                if (modal && modal.classList.contains('active')) { closeModal(id); return; }
            }
            if (document.getElementById('scanner-overlay').classList.contains('active')) { closeScanner(); return; }
            if (navigationHistory.length > 0) { openScreen(navigationHistory.pop(), false); return; }
            if (activeScreenId === 'home-screen') {
                if (confirm('Deseja sair do aplicativo?')) window.close();
            } else {
                openScreen('home-screen');
            }
        }

        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function(event) {
            history.pushState(null, null, location.href);
            handleBackButton();
        });

        // Scanner Functions
        function openScanner(mode) {
            scannerMode = mode;
            const titles = {
                'sales': 'Escaneie o cﾃｳdigo do produto',
                'product': 'Escaneie o cﾃｳdigo de barras',
                'sku': 'Escaneie o cﾃｳdigo de barras'
            };
            document.getElementById('scanner-title').textContent = titles[mode] || 'Escaneie o cﾃｳdigo';
            document.getElementById('scanner-overlay').classList.add('active');
            startWebScanner();
        }

        function closeScanner() {
            document.getElementById('scanner-overlay').classList.remove('active');
            stopScanner();
        }

        async function startWebScanner() {
            if (isScanning) return;
            isScanning = true;

            try {
                if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform && Capacitor.isNativePlatform()) {
                    if (typeof BarcodeScanner !== 'undefined') {
                        const status = await BarcodeScanner.checkPermission({ force: true });
                        if (status.granted) {
                            document.body.classList.add('scanner-active-native');
                            await BarcodeScanner.hideBackground();
                            const result = await BarcodeScanner.startScan();
                            if (result.hasContent) {
                                processScannedCode(result.content);
                            }
                            await BarcodeScanner.showBackground();
                            document.body.classList.remove('scanner-active-native');
                            closeScanner();
                            return;
                        }
                    }
                }

                if (typeof ZXing !== 'undefined') {
                    codeReader = new ZXing.BrowserMultiFormatReader();
                    const videoElement = document.getElementById('scanner-video');
                    
                    codeReader.decodeFromVideoDevice(undefined, videoElement, (result, err) => {
                        if (result && isScanning) {
                            processScannedCode(result.text);
                            closeScanner();
                        }
                    });
                } else {
                    const video = document.getElementById('scanner-video');
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = stream;
                    showToast('Aviso', 'Scanner bﾃ｡sico ativo. Digite o cﾃｳdigo manualmente se necessﾃ｡rio.', 'warning');
                }
            } catch (e) {
                console.error('Scanner error:', e);
                showToast('Erro', 'Nﾃ｣o foi possﾃｭvel acessar a cﾃ｢mera', 'error');
                closeScanner();
            }
        }

        function stopScanner() {
            isScanning = false;
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
            const video = document.getElementById('scanner-video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        function processScannedCode(code) {
            const cleanCode = String(code).trim();
            playBeep();

            if (scannerMode === 'sales') {
                // Search in all products (including not loaded)
                searchProductBySku(cleanCode);
            } else if (scannerMode === 'product' || scannerMode === 'sku') {
                document.getElementById('product-sku').value = cleanCode;
                if (scannerMode === 'product') {
                    const existing = allProducts.find(p => String(p.sku) === cleanCode);
                    if (existing) {
                        showToast('Produto Existente', existing.name, 'info');
                    }
                }
            }
        }

        async function searchProductBySku(sku) {
            // First check in loaded products
            let product = allProducts.find(p => String(p.sku) === sku || String(p.id) === sku);
            
            if (!product && currentUser) {
                // Search in Firebase
                try {
                    const snapshot = await db.collection('users').doc(currentUser.uid).collection('products')
                        .where('sku', '==', sku).limit(1).get();
                    
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        product = { ...doc.data(), id: doc.id };
                        // Add to allProducts if not exists
                        if (!allProducts.find(p => p.id === product.id)) {
                            allProducts.push(product);
                        }
                    }
                } catch (e) {
                    console.error('Search error:', e);
                }
            }

            if (product) {
                incrementCart(product.id);
                showToast('Produto Adicionado', product.name, 'success');
            } else {
                showToast('Nﾃ｣o Encontrado', 'Produto nﾃ｣o cadastrado', 'warning');
            }
        }

        function playBeep() {
            try {
                const ctx = new (window.AudioContext || webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.frequency.setValueAtTime(1000, ctx.currentTime);
                osc.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            } catch (e) {}
        }

        // Authentication
        /* --- NOVA FUNﾃﾃグ DE LOGIN Hﾃ坑RIDA (IGUAL PIXCOLETOR) --- */
async function loginWithGoogle() {
    const btn = document.getElementById('google-btn');
    const btnText = document.getElementById('google-btn-text');
    
    // 1. Validaﾃｧﾃ｣o de CPF antes de tentar logar
    const cpfInput = document.getElementById('login-cpf');
    const cpf = cpfInput ? cpfInput.value.replace(/\D/g, '') : "";
    
    if (cpf.length !== 11) {
        showToast('Atenﾃｧﾃ｣o', 'Digite um CPF vﾃ｡lido antes de entrar.', 'warning');
        if(cpfInput) cpfInput.focus();
        return;
    }

    // Trava o botﾃ｣o visualmente
    if (btn) btn.disabled = true;
    if (btnText) btnText.innerText = "Entrando...";

    try {
        const isNative = CapacitorObj && CapacitorObj.isNativePlatform();
        let userCredential = null;

        // --- TENTATIVA 1: MODO APK NATIVO (Plugin) ---
        if (isNative && GoogleAuth) {
            try {
                // Tenta inicializar (caso nﾃ｣o tenha sido feito no start)
                await GoogleAuth.initialize();
                
                // Abre o login nativo do Android
                const authResult = await GoogleAuth.signIn();
                
                // Converte para credencial do Firebase
                const credential = firebase.auth.GoogleAuthProvider.credential(authResult.authentication.idToken);
                userCredential = await auth.signInWithCredential(credential);
            
            } catch (pluginError) {
                console.warn("Plugin nativo falhou, tentando Popup...", pluginError);
            }
        }

        // --- TENTATIVA 2: MODO WEB/POPUP (Se o nativo falhar ou nﾃ｣o existir) ---
        if (!userCredential) {
            // Garante persistﾃｪncia LOCAL (mantﾃｩm logado ao fechar app)
            await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            
            // ATENﾃﾃグ: Usa signInWithPopup (NUNCA use Redirect no APK sem configuraﾃｧﾃ｣o deep link)
            userCredential = await auth.signInWithPopup(provider);
        }

        // --- SUCESSO: SALVAR DADOS ---
        const user = userCredential.user;
        localStorage.setItem('vendr_user_cpf', cpf);

        // Referﾃｪncia ao usuﾃ｡rio no banco
        const userRef = db.collection("users").doc(user.uid);
        const docSnap = await userRef.get();

        if (!docSnap.exists) {
            // Cria novo usuﾃ｡rio se nﾃ｣o existir
            await userRef.set({
                email: user.email,
                name: user.displayName,
                cpf: cpf,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                role: 'seller',
                isPremium: false,
                trialUsed: false
            });
        } else {
            // Atualiza ﾃｺltimo login se jﾃ｡ existir
            await userRef.update({
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        showToast("Sucesso", "Login realizado!", "success");
        // O redirecionamento acontece automaticamente pelo seu listener auth.onAuthStateChanged

    } catch (error) {
        console.error("Erro Login:", error);
        
        let msg = error.message;
        if (msg.includes('closed') || msg.includes('cancelled')) msg = "Login cancelado.";
        else if (msg.includes('network')) msg = "Verifique sua internet.";
        else if (msg.includes('popup')) msg = "Popup bloqueado. Verifique as permissﾃｵes.";
        
        showToast("Erro", msg, "error");
        
    } finally {
        // Destrava o botﾃ｣o
        if (btn) btn.disabled = false;
        if (btnText) btnText.innerText = "Entrar com Google";
    }
}



        auth.getRedirectResult().then((result) => {
            if (result.user) {
                currentUser = result.user;
                const pendingCPF = localStorage.getItem('pending_cpf');
                if (pendingCPF) {
                    localStorage.setItem('vendr_user_cpf', pendingCPF);
                    localStorage.removeItem('pending_cpf');
                    db.collection('users').doc(currentUser.uid).set({
                        email: currentUser.email,
                        name: currentUser.displayName,
                        cpf: pendingCPF,
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }
                showToast('Bem-vindo!', 'Login realizado com sucesso', 'success');
            }
        }).catch((error) => console.error('Redirect error:', error));

        function logout() {
    showCustomConfirm(
        'Sair da Conta', 
        'Tem certeza que deseja desconectar do JRVendI Pro?', 
        () => {
            // O cﾃｳdigo que realmente faz o logout
            auth.signOut().then(() => {
                currentUser = null;
                // Limpa variﾃ｡veis...
                products = []; allProducts = []; cart = [];
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('paywall-modal').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                closeModal('modal-user-menu');
                showToast('Atﾃｩ logo!', 'Vocﾃｪ foi desconectado', 'info');
            });
        }, 
        'warning' // Tipo Amarelo
    );
}


        function switchAccount() {
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('paywall-modal').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            });
        }

        // Premium Check with Trial Support
        function checkSubscriptionAndUnlock(uid) {
            db.collection('users').doc(uid).onSnapshot((doc) => {
                const now = new Date();
                isPremiumUser = false;
                isTrialUser = false;
                let premiumUntilDate = null;
                let trialEndDateValue = null;
                trialDaysLeft = 0;

                if (doc.exists) {
                    const data = doc.data();

                    if (data.premiumUntil) {
                        premiumUntilDate = new Date(data.premiumUntil + 'T23:59:59');
                        if (data.isPremium === true && premiumUntilDate > now) {
                            isPremiumUser = true;
                        }
                    }

                    if (!isPremiumUser && data.trialEndDate) {
                        trialEndDateValue = new Date(data.trialEndDate + 'T23:59:59');
                        if (trialEndDateValue > now) {
                            isTrialUser = true;
                            trialDaysLeft = Math.ceil((trialEndDateValue - now) / (1000 * 60 * 60 * 24));
                        }
                    }
                }

                document.getElementById('login-screen').style.display = 'none';

                if (isPremiumUser) {
                    document.getElementById('paywall-modal').style.display = 'none';
                    document.getElementById('app-container').style.display = 'flex';
                    document.getElementById('trial-banner').style.display = 'none';
                    document.getElementById('premium-until').textContent = premiumUntilDate.toLocaleDateString('pt-BR');
                    document.getElementById('premium-status-text').textContent = 'Premium Ativo';
                    document.getElementById('premium-status-card').className = 'premium-card';
                    localStorage.setItem('vendr_license_valid_until', premiumUntilDate.toLocaleDateString('pt-BR'));
                    canClosePaywall = true;
                    initApp();
                } else if (isTrialUser) {
                    document.getElementById('paywall-modal').style.display = 'none';
                    document.getElementById('app-container').style.display = 'flex';
                    document.getElementById('trial-banner').style.display = 'block';
                    document.getElementById('trial-days-left').textContent = trialDaysLeft;
                    document.getElementById('premium-until').textContent = trialEndDateValue.toLocaleDateString('pt-BR');
                    document.getElementById('premium-status-text').textContent = `Teste Grﾃ｡tis (${trialDaysLeft} dias)`;
                    document.getElementById('premium-status-card').className = 'premium-card trial';
                    canClosePaywall = true;
                    initApp();
                } else {
                    document.getElementById('paywall-modal').style.display = 'flex';
                    document.getElementById('app-container').style.display = 'none';
                    document.getElementById('premium-status-text').textContent = 'Expirado';
                    document.getElementById('premium-status-card').className = 'premium-card expired';
                    canClosePaywall = false;
                }

                updatePaywallCloseButton();
                hideSplashScreen();
            }, (error) => {
                console.error('Erro ao verificar premium:', error);
                hideSplashScreen();
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('paywall-modal').style.display = 'flex';
                canClosePaywall = false;
                updatePaywallCloseButton();
            });
        }

        function updatePaywallCloseButton() {
            const closeBtn = document.getElementById('paywall-close-btn');
            closeBtn.style.display = canClosePaywall ? 'flex' : 'none';
        }

        function showPaywall() {
            document.getElementById('paywall-modal').style.display = 'flex';
        }

        function closePaywall() {
            if (canClosePaywall) {
                document.getElementById('paywall-modal').style.display = 'none';
            }
        }

        function hideSplashScreen() {
            const splash = document.getElementById('splash-screen');
            if (splash) {
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 500);
            }
        }

        function updateTrialSettingsBox() {
            const box = document.getElementById('trial-settings-box');
            const daysSpan = document.getElementById('trial-days-settings');
            if (isTrialUser) {
                box.style.display = 'block';
                daysSpan.textContent = trialDaysLeft;
            } else {
                box.style.display = 'none';
            }
        }

        // Pix Payment
        function selectPlan(months, price, element) {
            selectedPlan = { months, price };
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('btn-generate-pix').style.display = 'flex';
        }

        async function generatePaymentPix() {
    if (!selectedPlan) { showToast('Atenﾃｧﾃ｣o', 'Selecione um plano primeiro', 'warning'); return; }

    let cpf = localStorage.getItem('vendr_user_cpf');
    
    // --- Lﾃ敵ICA CORRIGIDA ---
    if (!cpf || cpf.length < 11) { 
        document.getElementById('cpf-error-box').style.display = 'none';
        
        // Nﾃグ ESCONDEMOS MAIS O PAYWALL (Removemos a linha display='none')
        // Apenas abrimos o modal do CPF por cima (graﾃｧas ao CSS novo)
        openModal('modal-cpf'); 
        return; 
    }
    // -----------------------

    const btn = document.getElementById('btn-generate-pix');
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Gerando...';
    btn.disabled = true;

    try {
        const payment = await createPixPaymentAPI(selectedPlan.price, `JRVendI Pro - ${selectedPlan.months} Mﾃｪs(es)`, currentUser?.email || '', cpf);
        if (payment) {
            currentPaymentId = payment.id;
            showPixModal(payment.qr_code, payment.qr_code_base64, selectedPlan.price, selectedPlan.months);
            startPaymentStatusCheck(payment.id, selectedPlan.months);
        }
    } catch (e) {
        showToast('Erro', e.message, 'error');
    } finally {
        btn.innerHTML = '<i class="fab fa-pix"></i> Gerar QR Code Pix';
        btn.disabled = false;
    }
}


        async function createPixPaymentAPI(amount, description, email, cpf) {
            const url = 'https://api.mercadopago.com/v1/payments';
            const idemKey = 'PIX-' + Date.now();
            const cleanCPF = String(cpf).replace(/\D/g, '');
            const validEmail = (email && email.includes('@')) ? email : 'cliente_app@jrvendi.com';

            const bodyData = {
                transaction_amount: amount,
                description: description,
                payment_method_id: 'pix',
                payer: { email: validEmail, first_name: 'Cliente', last_name: 'JRVendI', identification: { type: 'CPF', number: cleanCPF } }
            };

            try {
                const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(url), {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${MP_ACCESS_TOKEN}`, 'Content-Type': 'application/json', 'X-Idempotency-Key': idemKey },
                    body: JSON.stringify(bodyData)
                });

                const data = await response.json();

                if (!response.ok) {
                    const msg = data.message || 'Erro desconhecido';
                    if (msg.includes('identification') || msg.includes('cpf') || msg.includes('invalid')) {
                        localStorage.removeItem('vendr_user_cpf');
                        document.getElementById('cpf-error-box').style.display = 'block';
                        openModal('modal-cpf');
                        return null;
                    } else {
                        showToast('Erro', msg, 'error');
                    }
                    return null;
                }

                return { id: data.id, qr_code: data.point_of_interaction.transaction_data.qr_code, qr_code_base64: data.point_of_interaction.transaction_data.qr_code_base64 };
            } catch (e) {
                showToast('Erro de Conexﾃ｣o', 'Verifique sua internet', 'error');
                return null;
            }
        }

        function showPixModal(code, base64, amount, months) {
            document.getElementById('pix-code-text').textContent = code;
            const canvas = document.getElementById('pix-qr-canvas');
            new QRious({ element: canvas, value: code, size: 200, level: 'H' });
            document.getElementById('paywall-modal').style.display = 'none';
            openModal('modal-pix');
        }

        function closePixModal() {
            closeModal('modal-pix');
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
                paymentCheckInterval = null;
            }
            document.getElementById('paywall-modal').style.display = 'flex';
        }

        function copyPixCode() {
            const code = document.getElementById('pix-code-text').textContent;
            navigator.clipboard.writeText(code).then(() => showToast('Copiado!', 'Cﾃｳdigo Pix copiado', 'success'));
        }

        function startPaymentStatusCheck(paymentId, months) {
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);
            paymentCheckInterval = setInterval(async () => {
                try {
                    const url = `https://api.mercadopago.com/v1/payments/${paymentId}`;
                    const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(url), { method: 'GET', headers: { 'Authorization': `Bearer ${MP_ACCESS_TOKEN}` } });
                    const data = await res.json();
                    if (data.status === 'approved') { clearInterval(paymentCheckInterval); approveUserAccess(months); }
                    else if (data.status === 'cancelled' || data.status === 'rejected') {
                        clearInterval(paymentCheckInterval);
                        showToast('Cancelado', 'Pagamento nﾃ｣o aprovado', 'error');
                        closeModal('modal-pix');
                        document.getElementById('paywall-modal').style.display = 'flex';
                    }
                } catch (e) { console.error('Erro verificaﾃｧﾃ｣o:', e); }
            }, 4000);
        }

        async function approveUserAccess(months) {
            closeModal('modal-pix');
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);

            const now = new Date();
            const futureDate = new Date(now.setMonth(now.getMonth() + months));
            const dateFirebase = futureDate.toISOString().split('T')[0];
            const dateLocal = futureDate.toLocaleDateString('pt-BR');

            localStorage.setItem('vendr_license_valid_until', dateLocal);

            if (currentUser) {
                await db.collection('users').doc(currentUser.uid).set({
                    premiumUntil: dateFirebase,
                    isPremium: true,
                    lastPaymentId: 'PIX_' + currentPaymentId,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }

            showSuccessScreen(dateLocal);
        }

        function showSuccessScreen(date) {
            document.getElementById('success-date').textContent = date;
            document.getElementById('success-screen').style.display = 'flex';
        }

        function closeSuccessScreen() {
            document.getElementById('success-screen').style.display = 'none';
            document.getElementById('paywall-modal').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            document.getElementById('trial-banner').style.display = 'none';
            canClosePaywall = true;
            initApp();
        }

        function confirmCPF() {
            const cpf = document.getElementById('cpf-input-field').value.replace(/\D/g, '');
            if (cpf.length !== 11) { 
                showToast('Atenﾃｧﾃ｣o', 'CPF invﾃ｡lido', 'warning'); 
                return; 
            }
            localStorage.setItem('vendr_user_cpf', cpf);
            document.getElementById('cpf-error-box').style.display = 'none';
            closeModal('modal-cpf');
            generatePaymentPix();
        }

        // Coletor QR Code
        function openColetorScreen() { openScreen('coletor-screen'); }

        function generateColetorQR() {
            if (!currentUser) return;
            const uid = currentUser.uid;
            const canvas = document.getElementById('coletor-qr-canvas');
            new QRious({ element: canvas, value: uid, size: 200, level: 'H', background: 'white', foreground: '#0a0e27' });
            document.getElementById('coletor-uid-display').textContent = uid;
        }

        function copyColetorCode() {
            if (!currentUser) return;
            navigator.clipboard.writeText(currentUser.uid).then(() => showToast('Copiado!', 'Cﾃｳdigo do coletor copiado', 'success'));
        }

        // Products with Pagination
        function loadProducts() {
            if (!currentUser) return;
            
            // Load all products for search
            db.collection('users').doc(currentUser.uid).collection('products').orderBy('name').onSnapshot(snapshot => {
                allProducts = [];
                snapshot.forEach(doc => allProducts.push({ ...doc.data(), id: doc.id }));
            });
        }

        function renderProductsList() {
            const container = document.getElementById('products-list');
            const loadMoreBtn = document.getElementById('load-more-products-btn');
            
            const start = 0;
            const end = productsLoaded + PRODUCTS_PER_PAGE;
            const toShow = allProducts.slice(start, end);
            productsLoaded = end;

            if (toShow.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><p>Nenhum produto cadastrado</p></div>';
                loadMoreBtn.style.display = 'none';
                return;
            }

            container.innerHTML = toShow.map(p => `
                <div class="list-item" onclick="editProduct('${p.id}')">
                    <div class="list-item-avatar">${p.image ? `<img src="${p.image}" alt="${p.name}">` : '<i class="fas fa-box"></i>'}</div>
                    <div class="list-item-info">
                        <div class="list-item-title">${p.name}</div>
                        <div class="list-item-subtitle">Estoque: ${p.quantity || p.stock || 0}</div>
                    </div>
                    <div class="list-item-price">${formatCurrency(p.price)}</div>
                </div>
            `).join('');

            loadMoreBtn.style.display = productsLoaded < allProducts.length ? 'flex' : 'none';
        }

        function loadMoreProducts() {
            renderProductsList();
        }

        // --- FUNﾃﾃ髭S DE CADASTRO E EDIﾃﾃグ ATUALIZADAS ---

// 1. Funﾃｧﾃ｣o para abrir o modal LIMPO (Novo Produto)
function openAddProductModal() {
    limparCamposProduto();
    document.getElementById('editing-product-id').value = ''; // Garante que nﾃ｣o tem ID
    document.querySelector('#modal-add-product .modal-title').textContent = 'Novo Produto';
    
    // Esconde o botﾃ｣o de excluir se for novo
    const btnDelete = document.getElementById('btn-delete-product-modal');
    if(btnDelete) btnDelete.style.display = 'none';
    
    openModal('modal-add-product');
}

// 2. Funﾃｧﾃ｣o para abrir o modal PREENCHIDO (Editar Produto)
function editProduct(id) {
    const product = allProducts.find(p => p.id === id);
    if (!product) return;

    // Preenche os campos
    document.getElementById('editing-product-id').value = product.id;
    document.getElementById('product-name').value = product.name;
    document.getElementById('product-price').value = product.price;
    document.getElementById('product-quantity').value = product.quantity || product.stock || 0;
    document.getElementById('product-sku').value = product.sku || '';
    document.getElementById('product-ncm').value = product.ncm || '';
    document.getElementById('product-cest').value = product.cest || '';
    
    // Mostra a imagem se tiver
    if (product.image) {
        document.getElementById('product-image-base64').value = product.image;
        document.getElementById('product-image-preview').innerHTML = `<img src="${product.image}" alt="Preview">`;
    } else {
        document.getElementById('product-image-preview').innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-camera"></i><div>Foto</div></div>';
    }

    // Muda o tﾃｭtulo e mostra botﾃ｣o de excluir
    document.querySelector('#modal-add-product .modal-title').textContent = 'Editar Produto';
    
    // Adiciona botﾃ｣o de excluir dinamicamente se nﾃ｣o existir
    let btnDelete = document.getElementById('btn-delete-product-modal');
    if (!btnDelete) {
        btnDelete = document.createElement('button');
        btnDelete.id = 'btn-delete-product-modal';
        btnDelete.className = 'btn btn-danger mt-10';
        btnDelete.innerHTML = '<i class="fas fa-trash"></i> Excluir Produto';
        btnDelete.onclick = () => deleteProductFromModal();
        document.querySelector('#modal-add-product .modal-box').appendChild(btnDelete);
    }
    btnDelete.style.display = 'block';

    openModal('modal-add-product');
}

// 3. Funﾃｧﾃ｣o de Salvar Inteligente (Cria ou Atualiza)
window.saveProduct = function() {
    const editingId = document.getElementById('editing-product-id').value;
    const name = document.getElementById('product-name').value.trim();
    const price = parseFloat(document.getElementById('product-price').value);
    const quantity = parseInt(document.getElementById('product-quantity').value) || 0;
    const sku = document.getElementById('product-sku').value.trim();
    const image = document.getElementById('product-image-base64').value;
    const ncm = document.getElementById('product-ncm').value.trim();
    const cest = document.getElementById('product-cest').value.trim();

    if (!name) { showToast('Atenﾃｧﾃ｣o', 'Nome obrigatﾃｳrio', 'warning'); return; }
    if (isNaN(price) || price <= 0) { showToast('Atenﾃｧﾃ｣o', 'Preﾃｧo invﾃ｡lido', 'warning'); return; }

    // Se tiver editingId, usa ele. Se nﾃ｣o, cria um novo baseada na hora.
    const id = editingId || Date.now().toString();

    const productData = { 
        id, name, price, originalPrice: price, quantity, stock: quantity, sku: sku || id, 
        ncm, cest,
        searchKey: name.toLowerCase(), image, 
        updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
    };
    
    // Usa .set() com merge:true para atualizar ou criar
    db.collection('users').doc(currentUser.uid).collection('products').doc(id).set(productData, { merge: true })
        .then(() => { 
            closeModal('modal-add-product'); 
            showToast('Sucesso', editingId ? 'Produto atualizado!' : 'Produto criado!', 'success');
            limparCamposProduto();
            loadProducts(); // Recarrega a lista
        })
        .catch(err => showToast('Erro', err.message, 'error'));
};

function deleteProductFromModal() {
    const id = document.getElementById('editing-product-id').value;
    
    showCustomConfirm(
        'Excluir Produto', 
        'Este produto serﾃ｡ removido permanentemente do estoque.', 
        () => {
            // A lﾃｳgica de exclusﾃ｣o
            db.collection('users').doc(currentUser.uid).collection('products').doc(id).delete()
            .then(() => {
                closeModal('modal-add-product');
                showToast('Sucesso', 'Produto excluﾃｭdo', 'success');
                loadProducts();
            });
        },
        'danger' // Tipo Vermelho
    );
}

// Variﾃ｡vel para guardar a aﾃｧﾃ｣o que serﾃ｡ executada
let pendingConfirmationAction = null;

/**
 * Abre um modal de confirmaﾃｧﾃ｣o profissional.
 * @param {string} title - O tﾃｭtulo (ex: "Excluir Produto")
 * @param {string} message - A mensagem explicativa
 * @param {function} actionCallback - A funﾃｧﾃ｣o que serﾃ｡ executada se clicar em SIM
 * @param {string} type - 'danger' (vermelho/lixo) ou 'warning' (amarelo/alerta)
 */
function showCustomConfirm(title, message, actionCallback, type = 'danger') {
    // 1. Configura os textos
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    
    // 2. Configura o ﾃｭcone e a cor do botﾃ｣o
    const iconBox = document.getElementById('confirm-icon-box');
    const iconClass = document.getElementById('confirm-icon-class');
    const confirmBtn = document.getElementById('btn-confirm-action');

    if (type === 'danger') {
        iconBox.style.color = 'var(--danger)';
        iconClass.className = 'fas fa-trash-alt';
        confirmBtn.className = 'btn btn-danger';
        confirmBtn.innerHTML = 'Excluir';
    } else {
        iconBox.style.color = 'var(--warning)';
        iconClass.className = 'fas fa-sign-out-alt'; // ﾃ皇one de saﾃｭda por padrﾃ｣o no warning
        confirmBtn.className = 'btn btn-primary'; // Laranja
        confirmBtn.innerHTML = 'Sim, Confirmar';
    }

    // 3. Define a aﾃｧﾃ｣o do botﾃ｣o Confirmar
    confirmBtn.onclick = function() {
        actionCallback(); // Executa a funﾃｧﾃ｣o passada
        closeModal('modal-universal-confirm'); // Fecha o modal
    };

    // 4. Abre o modal
    openModal('modal-universal-confirm');
}


        // --- SUBSTITUA A FUNﾃﾃグ searchProducts ANTIGA POR ESTA ---
async function searchProducts() {
    const search = document.getElementById('search-products')?.value.toLowerCase() || '';
    const container = document.getElementById('products-for-sale');
    const loadMoreBtn = document.getElementById('load-more-sales-btn');
    
    // Aplica a classe de Grid ao container
    container.className = 'products-grid-container';
    
    let filtered;
    
    if (search.length > 0) {
        // Busca local
        filtered = allProducts.filter(p => 
            p.name.toLowerCase().includes(search) || 
            (p.sku && String(p.sku).includes(search))
        );
        
        // Busca no Firebase se nﾃ｣o achar local
        if (filtered.length === 0 && currentUser) {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('products')
                    .orderBy('searchKey')
                    .startAt(search)
                    .endAt(search + '\uf8ff')
                    .limit(20)
                    .get();
                
                snapshot.forEach(doc => {
                    const product = { ...doc.data(), id: doc.id };
                    if (!allProducts.find(p => p.id === product.id)) {
                        allProducts.push(product);
                    }
                    filtered.push(product);
                });
            } catch (e) {
                console.error('Search error:', e);
            }
        }
        
        loadMoreBtn.style.display = 'none';
    } else {
        // Paginaﾃｧﾃ｣o normal
        const start = 0;
        const end = productsLoaded + PRODUCTS_PER_PAGE;
        filtered = allProducts.slice(start, end);
        productsLoaded = end;

        loadMoreBtn.style.display = productsLoaded < allProducts.length ? 'flex' : 'none';
    }

    if (filtered.length === 0) {
        container.classList.remove('products-grid-container'); // Remove grid para mensagem de erro centralizada
        container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>Nenhum produto encontrado</p></div>';
        return;
    }

    // GERA O HTML NO FORMATO DE CARTﾃ髭S (GRID)
    container.innerHTML = filtered.map(p => {
        const inCart = cart.find(c => c.id === p.id);
        return `
        <div class="product-card-sale">
            <div class="card-img-box">
                ${p.image ? `<img src="${p.image}" alt="${p.name}">` : '<i class="fas fa-box"></i>'}
            </div>
            
            <div class="card-title-sale">${p.name}</div>
            <div class="card-stock-sale">Estoque: ${p.quantity || p.stock || 0}</div>
            
            <div class="card-price-sale">${formatCurrency(p.price)}</div>

            ${inCart ? `
                <div class="grid-qty-control">
                    <button class="btn-qty-grid" onclick="decrementCart('${p.id}')">-</button>
                    <span style="font-weight:700; font-size: 1.1rem;">${inCart.qty}</span>
                    <button class="btn-qty-grid" onclick="incrementCart('${p.id}')">+</button>
                </div>
            ` : `
                <button class="btn-add-grid" onclick="addToCart('${p.id}')">
                    ADICIONAR
                </button>
            `}
        </div>
    `}).join('');
}


        function loadMoreProductsForSale() {
            searchProducts();
        }

        function addToCart(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;
    
    const existing = cart.find(c => c.id === productId);
    if (existing) { 
        existing.qty++; 
    } else { 
        // ATUALIZADO: Agora salvamos NCM e CEST no item do carrinho
        cart.push({ 
            id: productId, 
            name: product.name, 
            price: product.price, 
            qty: 1, 
            discount: 0,
            ncm: product.ncm || '', // Pega do cadastro
            cest: product.cest || '' // Pega do cadastro
        }); 
    }
    updateCartFloat();
    searchProducts();
}

// Funﾃｧﾃ｣o que faltava para o botﾃ｣o "+" do grid funcionar
function incrementCart(productId) {
    // Reutiliza a lﾃｳgica de adicionar, que jﾃ｡ soma +1 se existir
    addToCart(productId);
}

        function decrementCart(productId) {
            const idx = cart.findIndex(c => c.id === productId);
            if (idx !== -1) {
                if (cart[idx].qty > 1) cart[idx].qty--;
                else cart.splice(idx, 1);
                updateCartFloat();
                searchProducts();
            }
        }

        function updateCartFloat() {
            const cartFloat = document.getElementById('cart-float');
            const count = cart.reduce((sum, c) => sum + c.qty, 0);
            const total = cart.reduce((sum, c) => sum + (c.price * c.qty), 0);
            document.getElementById('cart-count').textContent = count;
            document.getElementById('cart-total').textContent = total.toFixed(2).replace('.', ',');
            
            // Only show cart float on sales screen
            if (activeScreenId === 'sales-screen' && count > 0) {
                cartFloat.classList.add('active');
            } else {
                cartFloat.classList.remove('active');
            }
        }

        // Checkout with Individual Discounts
        function updateCheckoutItems() {
            const container = document.getElementById('checkout-items');
            let subtotal = 0;
            let totalDiscounts = 0;

            container.innerHTML = cart.map(item => {
                const itemSubtotal = item.price * item.qty;
                const discount = item.discount || 0;
                const itemTotal = itemSubtotal - discount;
                subtotal += itemSubtotal;
                totalDiscounts += discount;
                return `
                <div class="checkout-item">
                    <div class="checkout-item-header">
                        <div>
                            <div class="checkout-item-name">${item.name}</div>
                            <div class="checkout-item-qty">${item.qty}x ${formatCurrency(item.price)}</div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="decrementCheckout('${item.id}')">-</button>
                            <span class="quantity-display">${item.qty}</span>
                            <button class="quantity-btn" onclick="incrementCheckout('${item.id}')">+</button>
                        </div>
                    </div>
                    <div class="checkout-item-discount">
                        <label>Desconto R$:</label>
                        <input type="number" value="${discount.toFixed(2)}" step="0.01" min="0" max="${itemSubtotal}" 
                            onchange="updateItemDiscount('${item.id}', this.value)">
                        <div class="checkout-item-total">${formatCurrency(itemTotal)}</div>
                    </div>
                </div>
            `}).join('');

            const total = subtotal - totalDiscounts;
            document.getElementById('checkout-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('checkout-discounts').textContent = `- ${formatCurrency(totalDiscounts)}`;
            document.getElementById('checkout-total').textContent = formatCurrency(total);
        }

        function incrementCheckout(id) {
            const item = cart.find(c => c.id === id);
            if (item) { item.qty++; updateCheckoutItems(); }
        }

        function decrementCheckout(id) {
            const idx = cart.findIndex(c => c.id === id);
            if (idx !== -1) {
                if (cart[idx].qty > 1) cart[idx].qty--;
                else cart.splice(idx, 1);
                updateCheckoutItems();
                if (cart.length === 0) { openScreen('sales-screen'); }
            }
        }

        function updateItemDiscount(id, value) {
            const item = cart.find(c => c.id === id);
            if (item) {
                const maxDiscount = item.price * item.qty;
                item.discount = Math.min(parseFloat(value) || 0, maxDiscount);
                updateCheckoutItems();
            }
        }

        function cancelSale() {
            if (confirm('Deseja cancelar esta venda?')) {
                cart = [];
                updateCartFloat();
                openScreen('sales-screen');
                showToast('Cancelado', 'Venda cancelada', 'info');
            }
        }

        function showConfirmSaleModal() {
            if (cart.length === 0) { showToast('Atenﾃｧﾃ｣o', 'Carrinho vazio', 'warning'); return; }
            
            const summary = document.getElementById('confirm-sale-summary');
            summary.innerHTML = cart.map(item => {
                const itemTotal = (item.price * item.qty) - (item.discount || 0);
                return `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                    <span>${item.qty}x ${item.name}</span>
                    <span>${formatCurrency(itemTotal)}</span>
                </div>`;
            }).join('');

            const subtotal = cart.reduce((sum, c) => sum + (c.price * c.qty), 0);
            const discounts = cart.reduce((sum, c) => sum + (c.discount || 0), 0);
            const total = subtotal - discounts;
            document.getElementById('confirm-sale-total').textContent = formatCurrency(total);
            
            openModal('modal-confirm-sale');
        }

        // Variﾃ｡vel global para guardar a venda temporariamente
let lastSaleData = null;

async function completeSale() {
    closeModal('modal-confirm-sale');
    
    // Pega os dados do formulﾃ｡rio
    const method = document.getElementById('payment-method').value;
    const subtotal = cart.reduce((sum, c) => sum + (c.price * c.qty), 0);
    const discounts = cart.reduce((sum, c) => sum + (c.discount || 0), 0);
    const total = subtotal - discounts;
    const saleId = Date.now().toString();

    // Cria o objeto da venda
    const saleData = {
        id: saleId,
        items: cart.map(c => ({ 
            id: c.id, 
            name: c.name, 
            price: c.price, 
            qty: c.qty, 
            discount: c.discount || 0,
            ncm: c.ncm || '', 
            cest: c.cest || '' 
        })),
        subtotal,
        discount: discounts,
        total,
        method,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        date: new Date().toISOString().split('T')[0]
    };

    try {
        // 1. Salva no banco de dados
        await db.collection('users').doc(currentUser.uid).collection('sales').doc(saleId).set(saleData);
        
        // 2. Atualiza estoque
        for (const item of cart) {
            const productRef = db.collection('users').doc(currentUser.uid).collection('products').doc(item.id);
            await productRef.update({
                quantity: firebase.firestore.FieldValue.increment(-item.qty),
                stock: firebase.firestore.FieldValue.increment(-item.qty)
            });
        }

        // 3. Salva os dados na variﾃ｡vel global para usar nos botﾃｵes
        lastSaleData = saleData;

        // 4. Limpa o carrinho
        cart = [];
        updateCartFloat();

        // 5. ABRE O NOVO MODAL BONITO (Em vez do alert feio)
        openModal('modal-sale-success');

    } catch (e) {
        showToast('Erro', 'Falha ao salvar venda: ' + e.message, 'error');
    }
}

// --- FUNﾃﾃ髭S DOS BOTﾃ髭S DO NOVO MODAL ---

function downloadCurrentPDF() {
    if (lastSaleData) {
        exportSaleReceiptPDF(lastSaleData);
    }
}

function shareCurrentWhatsApp() {
    if (lastSaleData) {
        shareReceiptWhatsApp(lastSaleData);
    }
}

function finishAndClose() {
    closeModal('modal-sale-success');
    openScreen('home-screen'); // Volta para a tela inicial
    lastSaleData = null; // Limpa a memﾃｳria
}










        function shareReceiptWhatsApp(sale) {
            const storeName = storeSettings.name || 'JRVendI';
            const storeFooter = storeSettings.footer || 'Obrigado pela preferﾃｪncia!';
            let msg = `*ｧｾ COMPROVANTE DE VENDA*\n`;
            msg += `*${storeName}*\n`;
            msg += `笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤\n`;
            msg += `套 ${new Date().toLocaleString('pt-BR')}\n`;
            msg += `箸 #${sale.id.slice(-6)}\n\n`;
            msg += `*ITENS:*\n`;
            sale.items.forEach(item => {
                const itemTotal = (item.price * item.qty) - (item.discount || 0);
                msg += `窶｢ ${item.qty}x ${item.name}\n`;
                msg += `  ${formatCurrency(item.price)} cada`;
                if (item.discount > 0) msg += ` (-${formatCurrency(item.discount)})`;
                msg += `\n  *Subtotal: ${formatCurrency(itemTotal)}*\n`;
            });
            msg += `\n笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤\n`;
            if (sale.discount > 0) {
                msg += `Subtotal: ${formatCurrency(sale.subtotal)}\n`;
                msg += `Desconto: -${formatCurrency(sale.discount)}\n`;
            }
            msg += `*TOTAL: ${formatCurrency(sale.total)}*\n`;
            msg += `諜 ${sale.method}\n`;
            msg += `笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤\n`;
            msg += `_${storeFooter}_`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Waitlist
        function saveToWaitlist() {
            if (cart.length === 0) { showToast('Atenﾃｧﾃ｣o', 'Carrinho vazio', 'warning'); return; }
            const waitId = Date.now().toString();
            const waitData = {
                id: waitId,
                items: [...cart],
                total: cart.reduce((sum, c) => sum + (c.price * c.qty) - (c.discount || 0), 0),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('users').doc(currentUser.uid).collection('waitlist').doc(waitId).set(waitData)
                .then(() => {
                    cart = [];
                    updateCartFloat();
                    openScreen('waitlist-screen');
                    showToast('Sucesso', 'Venda em espera', 'success');
                });
        }

        function loadWaitlist() {
            if (!currentUser) return;
            db.collection('users').doc(currentUser.uid).collection('waitlist').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                waitlist = [];
                snapshot.forEach(doc => waitlist.push({ ...doc.data(), id: doc.id }));
                if (activeScreenId === 'waitlist-screen') renderWaitlist();
            });
        }

        function renderWaitlist() {
            const container = document.getElementById('waitlist-items');
            if (waitlist.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-clock"></i><p>Nenhuma venda em espera</p></div>';
                return;
            }
            container.innerHTML = waitlist.map(w => `
                <div class="card">
                    <div class="flex-between mb-10">
                        <span style="font-weight: 700;">#${w.id.slice(-6)}</span>
                        <span class="badge badge-warning">Em Espera</span>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px;">
                        ${w.items.length} item(ns) - ${formatCurrency(w.total)}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary btn-small" onclick="resumeWaitlist('${w.id}')" style="flex: 1;">
                            <i class="fas fa-play"></i> Continuar
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteWaitlist('${w.id}')" style="width: auto;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function resumeWaitlist(id) {
            const wait = waitlist.find(w => w.id === id);
            if (wait) {
                cart = [...wait.items];
                updateCartFloat();
                db.collection('users').doc(currentUser.uid).collection('waitlist').doc(id).delete();
                openScreen('sales-screen');
                showToast('Sucesso', 'Venda restaurada', 'success');
            }
        }

        function deleteWaitlist(id) {
            if (confirm('Excluir esta venda em espera?')) {
                db.collection('users').doc(currentUser.uid).collection('waitlist').doc(id).delete()
                    .then(() => showToast('Sucesso', 'Removido da espera', 'success'));
            }
        }

        // Clients
        function loadClients() {
            if (!currentUser) return;
            db.collection('users').doc(currentUser.uid).collection('clients').orderBy('name').onSnapshot(snapshot => {
                clients = [];
                snapshot.forEach(doc => clients.push({ ...doc.data(), id: doc.id }));
                if (activeScreenId === 'clients-screen') renderClientsList();
            });
        }

        function renderClientsList() {
            const container = document.getElementById('clients-list');
            if (clients.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>Nenhum cliente cadastrado</p></div>';
                return;
            }
            container.innerHTML = clients.map(c => `
                <div class="list-item" onclick="deleteClient('${c.id}')">
                    <div class="list-item-avatar"><i class="fas fa-user"></i></div>
                    <div class="list-item-info">
                        <div class="list-item-title">${c.name}</div>
                        <div class="list-item-subtitle">${c.phone || 'Sem telefone'}</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                </div>
            `).join('');
        }

        function openAddClientModal() {
            document.getElementById('client-name').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-address').value = '';
            openModal('modal-add-client');
        }

        function saveClient() {
            const name = document.getElementById('client-name').value.trim();
            const phone = document.getElementById('client-phone').value.trim();
            const address = document.getElementById('client-address').value.trim();
            if (!name) { showToast('Atenﾃｧﾃ｣o', 'Digite o nome', 'warning'); return; }
            const id = Date.now().toString();
            db.collection('users').doc(currentUser.uid).collection('clients').doc(id).set({
                id, name, phone, address, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { closeModal('modal-add-client'); showToast('Sucesso', 'Cliente salvo', 'success'); });
        }

        function deleteClient(id) {
            const client = clients.find(c => c.id === id);
            if (client && confirm(`Excluir "${client.name}"?`)) {
                db.collection('users').doc(currentUser.uid).collection('clients').doc(id).delete()
                    .then(() => showToast('Sucesso', 'Cliente excluﾃｭdo', 'success'));
            }
        }

        async function addClientFromContacts() {
            try {
                // Try native Capacitor first
                if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform && Capacitor.isNativePlatform()) {
                    if (typeof Contacts !== 'undefined') {
                        const permission = await Contacts.requestPermissions();
                        if (permission.contacts === 'granted') {
                            const result = await Contacts.pickContact({ projection: { name: true, phones: true } });
                            if (result.contact) {
                                const name = result.contact.name?.display || result.contact.name?.given || 'Sem nome';
                                const phone = result.contact.phones?.[0]?.number || '';
                                document.getElementById('client-name').value = name;
                                document.getElementById('client-phone').value = phone;
                                openModal('modal-add-client');
                                return;
                            }
                        }
                    }
                }

                // Try Web Contact Picker API
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = { multiple: false };
                    const contacts = await navigator.contacts.select(props, opts);
                    if (contacts.length > 0) {
                        const contact = contacts[0];
                        document.getElementById('client-name').value = contact.name?.[0] || '';
                        document.getElementById('client-phone').value = contact.tel?.[0] || '';
                        openModal('modal-add-client');
                        return;
                    }
                }

                showToast('Indisponﾃｭvel', 'Agenda nﾃ｣o suportada neste dispositivo. Adicione manualmente.', 'warning');
                openModal('modal-add-client');
            } catch (e) {
                console.error('Contacts error:', e);
                showToast('Erro', 'Nﾃ｣o foi possﾃｭvel acessar a agenda', 'error');
                openModal('modal-add-client');
            }
        }

        // Expenses
        function loadExpenses() {
            if (!currentUser) return;
            db.collection('users').doc(currentUser.uid).collection('expenses').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                expenses = [];
                snapshot.forEach(doc => expenses.push({ ...doc.data(), id: doc.id }));
                if (activeScreenId === 'expenses-screen') renderExpensesList();
            });
        }

        function openExpensesScreen() { openScreen('expenses-screen'); }

        function renderExpensesList() {
            const container = document.getElementById('expenses-list');
            const total = expenses.reduce((sum, e) => sum + (e.value || 0), 0);
            document.getElementById('total-expenses-display').textContent = formatCurrency(total);

            if (expenses.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-receipt"></i><p>Nenhuma despesa registrada</p></div>';
                return;
            }
            container.innerHTML = expenses.map(e => `
                <div class="list-item" onclick="deleteExpense('${e.id}')">
                    <div class="list-item-avatar" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">
                        <i class="fas fa-minus-circle"></i>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-title">${e.description}</div>
                        <div class="list-item-subtitle">${e.category || 'Geral'}</div>
                    </div>
                    <div class="list-item-price" style="color: var(--danger);">-${formatCurrency(e.value)}</div>
                </div>
            `).join('');
        }

        function openAddExpenseModal() {
            document.getElementById('expense-desc').value = '';
            document.getElementById('expense-value').value = '';
            document.getElementById('expense-category').value = 'Geral';
            openModal('modal-add-expense');
        }

        function saveExpense() {
            const description = document.getElementById('expense-desc').value.trim();
            const value = parseFloat(document.getElementById('expense-value').value);
            const category = document.getElementById('expense-category').value;
            if (!description) { showToast('Atenﾃｧﾃ｣o', 'Digite a descriﾃｧﾃ｣o', 'warning'); return; }
            if (isNaN(value) || value <= 0) { showToast('Atenﾃｧﾃ｣o', 'Digite um valor vﾃ｡lido', 'warning'); return; }
            const id = Date.now().toString();
            db.collection('users').doc(currentUser.uid).collection('expenses').doc(id).set({
                id, description, value, category,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                date: new Date().toISOString().split('T')[0]
            }).then(() => { closeModal('modal-add-expense'); showToast('Sucesso', 'Despesa registrada', 'success'); });
        }

        function deleteExpense(id) {
            if (confirm('Excluir esta despesa?')) {
                db.collection('users').doc(currentUser.uid).collection('expenses').doc(id).delete()
                    .then(() => showToast('Sucesso', 'Despesa excluﾃｭda', 'success'));
            }
        }

        // Supplier Orders
        function renderSupplierList() {
            const container = document.getElementById('supplier-list');
            if (supplierOrders.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-truck"></i><p>Lista de pedidos vazia</p></div>';
                return;
            }
            container.innerHTML = supplierOrders.map((item, idx) => `
                <div class="supplier-item">
                    <div class="supplier-item-info">
                        <div class="supplier-item-name">${item.name}</div>
                        <div class="supplier-item-qty">Qtd: ${item.qty}${item.obs ? ` - ${item.obs}` : ''}</div>
                    </div>
                    <div class="supplier-item-actions">
                        <button onclick="decrementSupplierItem(${idx})" style="background: var(--card-light); color: var(--text-main);">-</button>
                        <button onclick="incrementSupplierItem(${idx})" style="background: var(--brand); color: white;">+</button>
                        <button onclick="removeSupplierItem(${idx})" style="background: var(--danger); color: white;"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function openAddSupplierItemModal() {
            document.getElementById('supplier-item-name').value = '';
            document.getElementById('supplier-item-qty').value = '1';
            document.getElementById('supplier-item-obs').value = '';
            openModal('modal-add-supplier-item');
        }

        function saveSupplierItem() {
            const name = document.getElementById('supplier-item-name').value.trim();
            const qty = parseInt(document.getElementById('supplier-item-qty').value) || 1;
            const obs = document.getElementById('supplier-item-obs').value.trim();
            if (!name) { showToast('Atenﾃｧﾃ｣o', 'Digite o nome do produto', 'warning'); return; }
            supplierOrders.push({ name, qty, obs });
            closeModal('modal-add-supplier-item');
            renderSupplierList();
            showToast('Sucesso', 'Item adicionado', 'success');
        }

        function incrementSupplierItem(idx) { supplierOrders[idx].qty++; renderSupplierList(); }
        function decrementSupplierItem(idx) { if (supplierOrders[idx].qty > 1) supplierOrders[idx].qty--; renderSupplierList(); }
        function removeSupplierItem(idx) { supplierOrders.splice(idx, 1); renderSupplierList(); }

        function exportSupplierPDF() {
            if (supplierOrders.length === 0) { showToast('Atenﾃｧﾃ｣o', 'Lista vazia', 'warning'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const storeName = storeSettings.name || 'JRVendI';

            // Header
            doc.setFillColor(255, 102, 0);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text(storeName, 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('PEDIDO PARA FORNECEDOR', 105, 32, { align: 'center' });

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 50);

            // Table
            doc.autoTable({
                startY: 60,
                head: [['#', 'Produto', 'Quantidade', 'Observaﾃｧﾃ｣o']],
                body: supplierOrders.map((item, idx) => [idx + 1, item.name, item.qty, item.obs || '-']),
                theme: 'striped',
                headStyles: { fillColor: [255, 102, 0] }
            });

            doc.save(`pedido_fornecedor_${Date.now()}.pdf`);
            showToast('Sucesso', 'PDF gerado!', 'success');
        }

        function shareSupplierWhatsApp() {
            if (supplierOrders.length === 0) { showToast('Atenﾃｧﾃ｣o', 'Lista vazia', 'warning'); return; }
            const storeName = storeSettings.name || 'JRVendI';
            let msg = `*逃 PEDIDO PARA FORNECEDOR*\n`;
            msg += `*${storeName}*\n`;
            msg += `笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤\n`;
            msg += `套 ${new Date().toLocaleDateString('pt-BR')}\n\n`;
            supplierOrders.forEach((item, idx) => {
                msg += `${idx + 1}. *${item.name}*\n`;
                msg += `   Qtd: ${item.qty}`;
                if (item.obs) msg += ` | Obs: ${item.obs}`;
                msg += `\n`;
            });
            msg += `\n笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Messages/Correio
        function loadMessages() {
            db.collection('system_messages').orderBy('timestamp', 'desc').limit(50).onSnapshot(snapshot => {
                const container = document.getElementById('messages-list');
                const messages = [];
                snapshot.forEach(doc => messages.push({ ...doc.data(), id: doc.id }));
                
                const unread = messages.length;
                const badge = document.getElementById('notification-badge');
                if (unread > 0) { badge.textContent = unread > 9 ? '9+' : unread; badge.style.display = 'block'; }
                else { badge.style.display = 'none'; }

                if (messages.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-envelope-open"></i><p>Nenhuma mensagem</p></div>';
                    return;
                }

                const typeColors = { info: 'var(--info)', success: 'var(--success)', warning: 'var(--warning)', danger: 'var(--danger)' };
                const typeIcons = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-triangle', danger: 'fa-times-circle' };

                container.innerHTML = messages.map(msg => {
                    const color = typeColors[msg.type] || typeColors.info;
                    const icon = typeIcons[msg.type] || typeIcons.info;
                    const date = msg.timestamp ? new Date(typeof msg.timestamp === 'number' ? msg.timestamp : msg.timestamp.toDate()).toLocaleDateString('pt-BR') : '';
                    const content = linkify(msg.message || msg.body || '');
                    const preview = (msg.message || msg.body || '').substring(0, 80) + ((msg.message || msg.body || '').length > 80 ? '...' : '');

                    return `
                    <div class="message-card" onclick="toggleMessage(this)">
                        <div class="message-card-header">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: ${color}20; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: ${color};">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div>
                                    <div class="message-card-title">${msg.title || 'Mensagem'}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">${date}</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-down message-card-arrow"></i>
                        </div>
                        <div class="message-card-body">
                            <div class="message-card-content">${content}</div>
                        </div>
                    </div>
                `}).join('');
            });
        }

        function toggleMessage(element) {
            element.classList.toggle('expanded');
        }

        // Reports
        function loadSales() {
            if (!currentUser) return;
            db.collection('users').doc(currentUser.uid).collection('sales').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                sales = [];
                snapshot.forEach(doc => sales.push({ ...doc.data(), id: doc.id }));
                if (activeScreenId === 'report-screen') generateReport();
                if (activeScreenId === 'history-screen') filterHistory(currentReportFilter);
                if (activeScreenId === 'home-screen') loadRecentSales();
            });
        }

        function loadRecentSales() {
            const container = document.getElementById('recent-sales-list');
            const recent = sales.slice(0, 5);
            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><i class="fas fa-receipt"></i><p>Nenhuma venda ainda</p></div>';
                return;
            }
            container.innerHTML = recent.map(s => `
                <div class="list-item" style="cursor: default;">
                    <div class="list-item-avatar" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-title">#${s.id.slice(-6)}</div>
                        <div class="list-item-subtitle">${s.items?.length || 0} item(ns) - ${s.method}</div>
                    </div>
                    <div class="list-item-price">${formatCurrency(s.total)}</div>
                </div>
            `).join('');
        }

        function filterReport(period, btn) {
            currentReportFilter = period;
            document.querySelectorAll('#report-screen .filter-pill').forEach(p => p.classList.remove('active'));
            if (btn) btn.classList.add('active');
            generateReport();
        }

        function generateReport() {
    // --- 1. Lﾃｳgica dos Cards (Nﾃｺmeros Totais) ---
    // (Mantﾃｩm a lﾃｳgica de filtrar os nﾃｺmeros lﾃ｡ em cima)
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    let filteredSales = sales;
    let filteredExpenses = expenses;

    if (currentReportFilter === 'today') {
        filteredSales = sales.filter(s => s.date === today);
        filteredExpenses = expenses.filter(e => e.date === today);
    } else if (currentReportFilter === 'week') {
        filteredSales = sales.filter(s => s.date >= weekAgo);
        filteredExpenses = expenses.filter(e => e.date >= weekAgo);
    } else if (currentReportFilter === 'month') {
        filteredSales = sales.filter(s => s.date >= monthAgo);
        filteredExpenses = expenses.filter(e => e.date >= monthAgo);
    }

    // Atualiza os nﾃｺmeros na tela
    const totalSales = filteredSales.reduce((sum, s) => sum + (s.total || 0), 0);
    const totalExpenses = filteredExpenses.reduce((sum, e) => sum + (e.value || 0), 0);
    const profit = totalSales - totalExpenses;

    document.getElementById('report-total-sales').textContent = formatCurrency(totalSales);
    document.getElementById('report-total-expenses').textContent = formatCurrency(totalExpenses);
    document.getElementById('report-profit').textContent = formatCurrency(profit);
    document.getElementById('report-profit').className = `stat-value ${profit >= 0 ? 'success' : 'danger'}`;
    document.getElementById('report-transactions').textContent = filteredSales.length;

    // --- 2. Lﾃｳgica do Grﾃ｡fico (SEMPRE ﾃ哭TIMOS 7 DIAS) ---
    const salesByDayMap = {};
    
    // Gera os ﾃｺltimos 7 dias (incluindo hoje) para o grﾃ｡fico nﾃ｣o ficar buraco vazio
    const last7DaysLabels = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD
        last7DaysLabels.push(dateStr);
        salesByDayMap[dateStr] = 0; // Inicia com zero
    }

    // Soma as vendas de todos os tempos nesses dias
    sales.forEach(s => {
        // Tenta pegar a data YYYY-MM-DD
        let day = s.date;
        if (!day && s.timestamp) {
            day = new Date(s.timestamp.seconds * 1000).toISOString().split('T')[0];
        }
        
        if (day && salesByDayMap.hasOwnProperty(day)) {
            salesByDayMap[day] += (s.total || 0);
        }
    });

    // Formata para o Grﾃ｡fico (DD/MM/AAAA)
    const chartLabels = last7DaysLabels.map(dateStr => {
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
    });

    const chartData = last7DaysLabels.map(d => salesByDayMap[d]);

    // Desenha
    if (salesChartInstance) salesChartInstance.destroy();
    const ctx = document.getElementById('sales-chart').getContext('2d');
    
    salesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [{ 
                label: 'Vendas', 
                data: chartData, 
                backgroundColor: '#FF6600', 
                borderRadius: 5,
                barThickness: 20
            }]
        },
        options: {
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: { label: (c) => formatCurrency(c.raw) }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: '#2d3a5c', drawBorder: false }, 
                    ticks: { color: '#a0aec0', callback: (v) => 'R$ ' + v } 
                },
                x: { 
                    grid: { display: false }, 
                    ticks: { color: '#a0aec0', font: { size: 10 } } 
                }
            }
        }
    });
}


        // ==========================================
// HISTﾃ迭ICO ATUALIZADO (COM BOTﾃグ PDF)
// ==========================================
function filterHistory(period, btn) {
    currentReportFilter = period;
    document.querySelectorAll('#history-screen .filter-pill').forEach(p => p.classList.remove('active'));
    if (btn) btn.classList.add('active');

    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    let filtered = sales;
    if (period === 'today') filtered = sales.filter(s => s.date === today);
    else if (period === 'week') filtered = sales.filter(s => s.date >= weekAgo);
    else if (period === 'month') filtered = sales.filter(s => s.date >= monthAgo);

    const container = document.getElementById('history-list');
    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-receipt"></i><p>Nenhuma venda no perﾃｭodo</p></div>';
        return;
    }

    container.innerHTML = filtered.map(s => {
        // Preparamos o objeto Sale para passar para as funﾃｧﾃｵes (escapando aspas para nﾃ｣o quebrar o HTML)
        const saleString = JSON.stringify(s).replace(/"/g, '&quot;');
        
        return `
        <div class="card">
            <div class="flex-between mb-10">
                <span style="font-weight: 700;">#${s.id.slice(-6)}</span>
                <span class="badge badge-success">Concluﾃｭda</span>
            </div>
            <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 10px;">
                ${s.date ? new Date(s.date + 'T12:00:00').toLocaleDateString('pt-BR') : '--'} | ${s.method}
            </div>
            <div style="font-size: 0.9rem; margin-bottom: 10px;">
                ${s.items?.map(i => `${i.qty}x ${i.name}`).join(', ') || 'Sem itens'}
            </div>
            <div class="flex-between" style="gap: 10px;">
                <span style="font-weight: 800; color: var(--brand); font-size: 1.1rem;">${formatCurrency(s.total)}</span>
                
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-small btn-primary" onclick="exportSaleReceiptPDF(${saleString})" style="width: auto; padding: 8px 12px;">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button class="btn btn-small btn-success" onclick="shareReceiptWhatsApp(${saleString})" style="width: auto; padding: 8px 12px;">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                </div>
            </div>
        </div>
    `}).join('');
}

// ==========================================
// PDF PROFISSIONAL (LOGO JRVENDI + DADOS LOJA SEPARADOS)
// ==========================================
function exportSaleReceiptPDF(sale) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Dados da Configuraﾃｧﾃ｣o
    const storeName = storeSettings.name || 'Sua Loja';
    const cnpj = storeSettings.cnpj || '';
    const phone = storeSettings.phone || '';
    const address = storeSettings.address || '';
    
    // Dados da Venda
    const saleId = sale.id.slice(-6);
    const saleDate = new Date(sale.timestamp?.seconds * 1000 || Date.now()).toLocaleString('pt-BR');
    
    // Cliente (Lﾃｳgica para pegar nome ou definir consumidor)
    const clientName = sale.clientName || sale.client?.name || 'Consumidor Final'; 
    const clientDoc = sale.clientCpf || sale.client?.cpf || '';

    // ==========================================
    // 1. LOGO DO APP (JRVENDI) - NO TOPO
    // ==========================================
    // Pequeno, centralizado e Laranja (Marca do Sistema)
    doc.setTextColor(255, 102, 0); // Laranja Brand
    doc.setFontSize(10); 
    doc.setFont('helvetica', 'bold');
    doc.text('JRVendI', 105, 10, { align: 'center' }); // Logo no topo bem discreto e pro

    // ==========================================
    // 2. CABEﾃ②LHO DA LOJA (QUEM VENDEU)
    // ==========================================
    // Nome da Loja (Maior e em Preto)
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text(storeName.toUpperCase(), 105, 18, { align: 'center' });
    
    // Dados da Loja (CNPJ, Endereﾃｧo - Cinza)
    doc.setTextColor(80, 80, 80);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    
    let infoY = 24;
    if(cnpj || phone) {
        let infoText = '';
        if(cnpj) infoText += `CNPJ: ${cnpj}`;
        if(cnpj && phone) infoText += `  |  `;
        if(phone) infoText += `Tel: ${phone}`;
        doc.text(infoText, 105, infoY, { align: 'center' });
        infoY += 4;
    }
    
    if(address) {
        doc.text(address, 105, infoY, { align: 'center' });
        infoY += 5;
    }

    // Linha Divisﾃｳria
    doc.setDrawColor(220, 220, 220); 
    doc.setLineWidth(0.5);
    doc.line(10, infoY + 2, 200, infoY + 2);

    // ==========================================
    // 3. DADOS DA VENDA E CLIENTE
    // ==========================================
    const dataY = infoY + 8;
    
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9);
    
    // Lado Esquerdo: Venda
    doc.setFont('helvetica', 'bold');
    doc.text(`VENDA #${saleId}`, 14, dataY);
    doc.setFont('helvetica', 'normal');
    doc.text(`Data: ${saleDate}`, 14, dataY + 5);
    doc.text(`Pagto: ${sale.method}`, 14, dataY + 10);
    
    // Lado Direito: Cliente
    doc.setFont('helvetica', 'bold');
    doc.text(`CLIENTE`, 140, dataY);
    doc.setFont('helvetica', 'normal');
    doc.text(clientName.toUpperCase(), 140, dataY + 5);
    if(clientDoc) doc.text(`CPF: ${clientDoc}`, 140, dataY + 10);

    // ==========================================
    // 4. TABELA DE PRODUTOS
    // ==========================================
    const tableBody = sale.items.map(item => [
        item.name,
        item.qty,
        formatCurrency(item.price),
        item.ncm || '-',
        item.cest || '-',
        formatCurrency((item.price * item.qty) - (item.discount || 0))
    ]);

    doc.autoTable({
        startY: dataY + 15,
        head: [['ITEM', 'QTD', 'UNIT', 'NCM', 'CEST', 'TOTAL']],
        body: tableBody,
        theme: 'plain', // Limpo
        styles: { 
            fontSize: 8, 
            cellPadding: 3, 
            textColor: 0, 
            lineColor: [230, 230, 230], // Linhas sutis
            lineWidth: 0.1
        },
        headStyles: { 
            fillColor: [255, 255, 255], 
            textColor: [0, 0, 0], // Cabeﾃｧalho Preto simples
            fontStyle: 'bold',
            borderBottomWidth: 1,
            borderColor: [0, 0, 0]
        },
        columnStyles: {
            0: { cellWidth: 60 },
            1: { halign: 'center' },
            2: { halign: 'right' },
            3: { halign: 'center', fontSize: 7 },
            4: { halign: 'center', fontSize: 7 },
            5: { halign: 'right', fontStyle: 'bold' }
        }
    });

    // ==========================================
    // 5. TOTAIS E RODAPﾃ
    // ==========================================
    const finalY = doc.lastAutoTable.finalY + 10;
    
    doc.setFontSize(10);
    doc.text(`Subtotal:`, 150, finalY);
    doc.text(formatCurrency(sale.subtotal || 0), 195, finalY, { align: 'right' });
    
    if (sale.discount > 0) {
        doc.setTextColor(200, 0, 0);
        doc.text(`Desconto:`, 150, finalY + 5);
        doc.text(`-${formatCurrency(sale.discount)}`, 195, finalY + 5, { align: 'right' });
    }

    // Total Final
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text(`TOTAL:`, 150, finalY + 14);
    
    // Valor Laranja (Destaque ﾃｺnico)
    doc.setTextColor(255, 102, 0);
    doc.text(formatCurrency(sale.total), 195, finalY + 14, { align: 'right' });

    // Rodapﾃｩ do Sistema
    const pageHeight = doc.internal.pageSize.height;
    doc.setDrawColor(200, 200, 200);
    doc.line(10, pageHeight - 15, 200, pageHeight - 15);
    
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor(150, 150, 150);
    
    // Mensagem da Loja
    doc.text(storeSettings.footer || 'Obrigado pela preferﾃｪncia!', 105, pageHeight - 10, { align: 'center' });
    
    // Crﾃｩdito do App discreto no canto
    doc.setFontSize(6);
    doc.text('Gerado por JRVendI Pro', 195, pageHeight - 5, { align: 'right' });

    doc.save(`Comprovante_${saleId}.pdf`);
    showToast('Sucesso', 'PDF Gerado!', 'success');
}

// --- FUNﾃﾃ髭S DE IMAGEM (COM COMPRESSﾃグ EXTREMA ~10KB) ---

function openImagePicker() {
    // Abre a cﾃ｢mera ou galeria
    document.getElementById('file-input').click();
}

function handleImageSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // Cria um canvas para redimensionar
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Define tamanho mﾃ｡ximo (ex: 300px) para garantir arquivo pequeno
            const MAX_WIDTH = 300;
            const MAX_HEIGHT = 300;
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
            } else {
                if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            // Comprime para JPEG com qualidade baixa (0.5) para atingir ~10KB
            const base64String = canvas.toDataURL('image/jpeg', 0.5);

            // Mostra o preview
            document.getElementById('product-image-preview').innerHTML = `<img src="${base64String}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">`;
            
            // Salva no input escondido para enviar ao banco
            document.getElementById('product-image-base64').value = base64String;
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

        // ==========================================
// RELATﾃ迭IO PDF PROFISSIONAL (CLEAN & PRO)
// ==========================================
function exportReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Dados da Loja
    const storeName = storeSettings.name || 'JRVendI';
    const footerText = storeSettings.footer || 'Sistema de Gestﾃ｣o JRVendI Pro';

    // ==========================================
    // 1. CABEﾃ②LHO (Igual ao Recibo)
    // ==========================================
    
    // Logo Pequeno
    doc.setTextColor(255, 102, 0); // Laranja
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('JRVendI', 105, 10, { align: 'center' });

    // Nome da Loja
    doc.setTextColor(0, 0, 0); // Preto
    doc.setFontSize(18);
    doc.text(storeName.toUpperCase(), 105, 18, { align: 'center' });

    // Tﾃｭtulo do Documento
    doc.setTextColor(80, 80, 80); // Cinza
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text('RELATﾃ迭IO FINANCEIRO DETALHADO', 105, 24, { align: 'center' });

    // Linha Laranja
    doc.setDrawColor(255, 102, 0);
    doc.setLineWidth(0.5);
    doc.line(14, 28, 196, 28);

    // ==========================================
    // 2. INFORMAﾃﾃ髭S DO PERﾃ弘DO
    // ==========================================
    
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9);
    doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 35);
    
    let periodoLabel = 'Todos os tempos';
    if(currentReportFilter === 'today') periodoLabel = 'Hoje';
    else if(currentReportFilter === 'week') periodoLabel = 'ﾃ嗟timos 7 Dias';
    else if(currentReportFilter === 'month') periodoLabel = 'ﾃ嗟timo Mﾃｪs';
    
    doc.text(`Perﾃｭodo analisado: ${periodoLabel}`, 14, 40);

    // ==========================================
    // 3. RESUMO FINANCEIRO (TABELA 1)
    // ==========================================
    
    // Pegando valores da tela para consistﾃｪncia
    const totalSales = document.getElementById('report-total-sales').textContent;
    const totalExpenses = document.getElementById('report-total-expenses').textContent;
    const profit = document.getElementById('report-profit').textContent;
    const transactions = document.getElementById('report-transactions').textContent;

    doc.autoTable({
        startY: 45,
        head: [['INDICADOR', 'VALOR']],
        body: [
            ['Total Bruto de Vendas', totalSales],
            ['Total de Despesas', totalExpenses],
            ['Lucro Lﾃｭquido', profit],
            ['Qtd. Vendas Realizadas', transactions]
        ],
        theme: 'grid',
        styles: { 
            fontSize: 10, 
            cellPadding: 4, 
            textColor: 0,
            lineColor: [220, 220, 220],
            lineWidth: 0.1
        },
        headStyles: { 
            fillColor: [255, 255, 255], 
            textColor: [0, 0, 0], 
            fontStyle: 'bold',
            borderBottomWidth: 1,
            borderColor: [0, 0, 0]
        },
        columnStyles: {
            0: { cellWidth: 100 },
            1: { halign: 'right', fontStyle: 'bold', textColor: [255, 102, 0] } // Valor Laranja
        }
    });

    // ==========================================
    // 4. DETALHAMENTO DE PRODUTOS (Lﾃｳgica de Agrupamento)
    // ==========================================
    
    // Filtra as vendas baseado no perﾃｭodo selecionado
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    let salesToExport = sales;
    if (currentReportFilter === 'today') salesToExport = sales.filter(s => s.date === today);
    else if (currentReportFilter === 'week') salesToExport = sales.filter(s => s.date >= weekAgo);
    else if (currentReportFilter === 'month') salesToExport = sales.filter(s => s.date >= monthAgo);

    // Agrupa itens vendidos (Soma quantidades do mesmo produto)
    const itemsMap = {};
    salesToExport.forEach(sale => {
        if (sale.items) {
            sale.items.forEach(item => {
                const id = item.id;
                if (!itemsMap[id]) {
                    itemsMap[id] = {
                        name: item.name,
                        qty: 0,
                        total: 0,
                        avgPrice: item.price
                    };
                }
                itemsMap[id].qty += (item.qty || 0);
                itemsMap[id].total += ((item.price * item.qty) - (item.discount || 0));
            });
        }
    });

    // Converte para lista e ordena por valor total vendido
    const itemsArray = Object.values(itemsMap).sort((a, b) => b.total - a.total);

    // Tﾃｭtulo da seﾃｧﾃ｣o
    doc.text('PRODUTOS VENDIDOS NO PERﾃ弘DO', 14, doc.lastAutoTable.finalY + 10);

    // Tabela Detalhada
    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 12,
        head: [['PRODUTO', 'QTD VENDIDA', 'TOTAL GERADO']],
        body: itemsArray.map(i => [
            i.name,
            i.qty,
            formatCurrency(i.total)
        ]),
        theme: 'plain', // Visual Limpo
        styles: { 
            fontSize: 9, 
            cellPadding: 3, 
            textColor: 0,
            lineColor: [230, 230, 230],
            lineWidth: 0.1,
            valign: 'middle'
        },
        headStyles: { 
            fillColor: [255, 255, 255], 
            textColor: [255, 102, 0], // Laranja Brand
            fontStyle: 'bold',
            borderBottomWidth: 1,
            borderColor: [255, 102, 0]
        },
        columnStyles: {
            0: { cellWidth: 100 },
            1: { halign: 'center' },
            2: { halign: 'right', fontStyle: 'bold' }
        }
    });

    // ==========================================
    // 5. RODAPﾃ
    // ==========================================
    const pageHeight = doc.internal.pageSize.height;
    
    // Linha rodapﾃｩ
    doc.setDrawColor(220, 220, 220);
    doc.line(10, pageHeight - 15, 200, pageHeight - 15);
    
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor(150, 150, 150);
    
    doc.text(footerText, 105, pageHeight - 10, { align: 'center' });
    doc.setFontSize(6);
    doc.text('Gerado por JRVendI Pro', 195, pageHeight - 5, { align: 'right' });

    // Salvar
    doc.save(`Relatorio_${currentReportFilter}_${Date.now()}.pdf`);
    showToast('Sucesso', 'Relatﾃｳrio Financeiro Gerado!', 'success');
}



        function shareReportWhatsApp() {
            const storeName = storeSettings.name || 'JRVendI';
            const totalSales = document.getElementById('report-total-sales').textContent;
            const totalExpenses = document.getElementById('report-total-expenses').textContent;
            const profit = document.getElementById('report-profit').textContent;
            const transactions = document.getElementById('report-transactions').textContent;

            let msg = `*投 RELATﾃ迭IO FINANCEIRO*\n`;
            msg += `*${storeName}*\n`;
            msg += `笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤\n`;
            msg += `套 ${new Date().toLocaleDateString('pt-BR')}\n`;
            msg += `東 Perﾃｭodo: ${currentReportFilter === 'today' ? 'Hoje' : currentReportFilter === 'week' ? 'Semana' : currentReportFilter === 'month' ? 'Mﾃｪs' : 'Todos'}\n\n`;
            msg += `腸 *Total Vendas:* ${totalSales}\n`;
            msg += `頂 *Total Despesas:* ${totalExpenses}\n`;
            msg += `嶋 *Lucro Lﾃｭquido:* ${profit}\n`;
            msg += `ｧｾ *Transaﾃｧﾃｵes:* ${transactions}\n`;
            msg += `笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤笏≫煤\n`;
            msg += `_${storeSettings.footer || 'JRVendI Pro'}_`;

            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Store Settings
        function loadStoreSettings() {
            if (!currentUser) return;
            db.collection('users').doc(currentUser.uid).collection('settings').doc('store').onSnapshot(doc => {
                if (doc.exists) {
                    storeSettings = doc.data();
                    document.getElementById('store-name').value = storeSettings.name || '';
                    document.getElementById('store-cnpj').value = storeSettings.cnpj || '';
                    document.getElementById('store-phone').value = storeSettings.phone || '';
                    document.getElementById('store-address').value = storeSettings.address || '';
                    document.getElementById('store-footer').value = storeSettings.footer || '';
                }
            });
        }

        function saveStoreSettings() {
            const name = document.getElementById('store-name').value.trim();
            const cnpj = document.getElementById('store-cnpj').value.trim();
            const phone = document.getElementById('store-phone').value.trim();
            const address = document.getElementById('store-address').value.trim();
            const footer = document.getElementById('store-footer').value.trim();

            storeSettings = { name, cnpj, phone, address, footer };

            db.collection('users').doc(currentUser.uid).collection('settings').doc('store').set(storeSettings, { merge: true })
                .then(() => showToast('Sucesso', 'Configuraﾃｧﾃｵes salvas', 'success'))
                .catch(err => showToast('Erro', 'Falha ao salvar', 'error'));
        }

        // User Menu
        function openUserMenu() {
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.displayName || 'Usuﾃ｡rio';
                document.getElementById('user-email').textContent = currentUser.email || '';
                
                let statusText = 'Verificando...';
                if (isPremiumUser) {
                    statusText = `Premium atﾃｩ ${localStorage.getItem('vendr_license_valid_until') || '--/--/----'}`;
                } else if (isTrialUser) {
                    statusText = `Teste grﾃ｡tis - ${trialDaysLeft} dias restantes`;
                } else {
                    statusText = 'Expirado';
                }
                document.getElementById('user-premium-status').textContent = statusText;
            }
            openModal('modal-user-menu');
        }

        // Init App
        function initApp() {
            loadProducts();
            loadClients();
            loadSales();
            loadExpenses();
            loadWaitlist();
            loadStoreSettings();
            loadMessages();
            openScreen('home-screen', false);
        }

        // Auth State
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                checkSubscriptionAndUnlock(user.uid);
            } else {
                hideSplashScreen();
                document.getElementById('login-screen').style.display = 'flex';
            }
        });

        // Hide splash after timeout
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            if (splash && splash.style.display !== 'none') {
                hideSplashScreen();
                if (!currentUser) {
                    document.getElementById('login-screen').style.display = 'flex';
                }
            }
        }, 3000);


























/* =================================================================================
   SISTEMA JURVENDI - VERSﾃグ FINAL UNIVERSAL (CELULAR + PC)
   ================================================================================= */

// Sua chave (Mantenha segura)
const GEMINI_API_KEY = 'AIzaSyDOFkLQPBufD9RrHWdgKPxCL8RrSUL3VO0'; 

let aiTimeout = null;
let currentAiResult = null; 

// =================================================================================
// 1. Lﾃ敵ICA DE BUSCA E INTELIGﾃ劾CIA ARTIFICIAL
// =================================================================================

// Funﾃｧﾃ｣o chamada quando vocﾃｪ digita no campo
function handleNameAndNcmSearch(query) {
    const resultsDiv = document.getElementById('name-ncm-results');
    // Proteﾃｧﾃ｣o contra erro se o elemento nﾃ｣o existir
    if (!resultsDiv) return;

    const container = resultsDiv.closest('.ncm-container');
    
    if (!query || query.length < 3) { 
        resultsDiv.classList.remove('active'); 
        if(container) container.classList.remove('searching');
        return; 
    }

    // Mostra "Pesquisando..."
    resultsDiv.classList.add('active');
    if(container) container.classList.add('searching');
    
    resultsDiv.innerHTML = `
        <div class="ncm-item" style="color:var(--brand); display:flex; align-items:center; gap:10px; padding:10px;">
            <i class="fas fa-satellite-dish fa-pulse"></i> 
            <div>
                <strong>Conectando IA...</strong><br>
                <span style="font-size:0.7rem; color:#666">Processando "${query}"</span>
            </div>
        </div>`;

    // Aguarda vocﾃｪ parar de digitar
    clearTimeout(aiTimeout);
    aiTimeout = setTimeout(() => {
        consultarGeminiProxy(query);
    }, 1000);
}

// Consulta ao Gemini usando PROXY (Para funcionar no Celular)
async function consultarGeminiProxy(produto) {
    const resultsDiv = document.getElementById('name-ncm-results');
    
    try {
        // URL Direta do Google
        const googleUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        // URL do Proxy (CORS Proxy) - Isso engana o celular para permitir a conexﾃ｣o
        // Se parar de funcionar, troque 'corsproxy.io/?' por 'api.allorigins.win/raw?url='
        const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(googleUrl);

        const promptBody = {
            contents: [{
                parts: [{
                    text: `Atue como Classificador Fiscal. Produto: "${produto}".
                           Retorne JSON ESTRITO (sem markdown):
                           {"ncm": "0000.00.00", "cest": "00.000.00", "descricao": "Nome tﾃｩcnico", "razao": "Explicaﾃｧﾃ｣o curta"}`
                }]
            }]
        };

        // Faz a requisiﾃｧﾃ｣o via Proxy
        const response = await fetch(proxyUrl, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(promptBody)
        });

        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

        const data = await response.json();
        
        // Limpa a resposta da IA
        let texto = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        texto = texto.replace(/```json/g, "").replace(/```/g, "").trim();
        
        const json = JSON.parse(texto);
        currentAiResult = json; // Salva para o modal
        renderizarResultado(json);

    } catch (erro) {
        console.error("Erro IA:", erro);
        resultsDiv.innerHTML = `
            <div class="ncm-item" style="color:red; padding:10px; border:1px solid red;">
                <i class="fas fa-wifi"></i> <strong>Erro de Conexﾃ｣o</strong><br>
                <span style="font-size:0.7rem;">O celular bloqueou a conexﾃ｣o.</span><br>
                <button onclick="handleNameAndNcmSearch('${produto}')" style="margin-top:5px; padding:5px;">Tentar Novamente</button>
            </div>`;
    }
}

// Mostra o resultado na lista
function renderizarResultado(dados) {
    const resultsDiv = document.getElementById('name-ncm-results');
    const ncm = dados.ncm || "0000.00.00";
    const cest = dados.cest || "";

    resultsDiv.innerHTML = `
        <div class="ncm-item-wrapper" style="border: 2px solid var(--brand); background: #fffaf0; animation: fadeIn 0.3s;">
            <div class="ncm-row" style="align-items: center; padding: 8px;">
                
                <div style="flex: 1; cursor: pointer;" onclick="aplicarDados('${ncm}', '${cest}')">
                    <div style="font-size:0.7rem; color:var(--brand); font-weight:bold;">
                        <i class="fas fa-check-circle"></i> IA ENCONTROU:
                    </div>
                    <strong style="font-size: 1.1rem; color: #2c3e50;">${ncm}</strong>
                    <div style="font-size:0.8rem; color:#555;">${dados.descricao}</div>
                </div>

                <div style="margin-left:10px; padding-left:10px; border-left:1px solid #eee;">
                    <button type="button" onclick="verDetalhesIA()" style="background:none; border:none; font-size:1.3rem; color:var(--brand); cursor:pointer;">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        </div>`;
}

// Aplica os valores nos campos
function aplicarDados(ncm, cest) {
    // Remove pontos para garantir compatibilidade
    const ncmL = ncm.replace(/\D/g, "").replace(/^(\d{4})(\d{2})/, "$1.$2");
    const cestL = cest ? cest.replace(/\D/g, "").replace(/^(\d{2})(\d{3})/, "$1.$2") : "";

    const elNcm = document.getElementById('product-ncm');
    const elCest = document.getElementById('product-cest');
    
    if(elNcm) elNcm.value = ncmL;
    if(elCest) elCest.value = cestL;
    
    // Esconde a lista
    const resultsDiv = document.getElementById('name-ncm-results');
    if(resultsDiv) resultsDiv.classList.remove('active');
    
    document.querySelectorAll('.ncm-container').forEach(el => el.classList.remove('searching'));
}

// Abre o Modal Escuro com Detalhes
function verDetalhesIA() {
    if(!currentAiResult) return;
    const d = currentAiResult;
    
    // Remove anterior se existir
    const antigo = document.getElementById('modal-detalhes-ia');
    if(antigo) antigo.remove();

    const html = `
    <div id="modal-detalhes-ia" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:99999; display:flex; align-items:center; justify-content:center; padding:20px;">
        <div style="background:#1a1f3a; padding:20px; border-radius:12px; width:100%; max-width:350px; border:1px solid var(--brand); color:white;">
            <h3 style="color:var(--brand); margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                <i class="fas fa-robot"></i> Anﾃ｡lise IA
            </h3>
            <p style="margin-bottom:5px; color:#aaa; font-size:0.8rem;">PRODUTO Tﾃ韻NICO</p>
            <p style="margin-bottom:15px; font-weight:bold; font-size:1.1rem;">${d.descricao}</p>
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div style="background:#333; padding:10px; border-radius:8px; flex:1; text-align:center;">
                    <span style="color:#aaa; font-size:0.7rem;">NCM</span><br>
                    <strong style="color:lightgreen;">${d.ncm}</strong>
                </div>
                <div style="background:#333; padding:10px; border-radius:8px; flex:1; text-align:center;">
                    <span style="color:#aaa; font-size:0.7rem;">CEST</span><br>
                    <strong style="color:cyan;">${d.cest || '--'}</strong>
                </div>
            </div>

            <p style="margin-bottom:5px; color:#aaa; font-size:0.8rem;">MOTIVO</p>
            <p style="margin-bottom:20px; font-size:0.9rem; color:#ccc; line-height:1.4;">${d.razao}</p>
            
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('modal-detalhes-ia').remove()" class="btn" style="flex:1; background:#444; color:white;">Voltar</button>
                <button onclick="aplicarDados('${d.ncm}', '${d.cest}'); document.getElementById('modal-detalhes-ia').remove()" class="btn btn-primary" style="flex:1;">Usar</button>
            </div>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
}


// =================================================================================
// 2. FUNﾃﾃ髭S DO SISTEMA (MODAIS, SALVAR, EXCLUIR) - RESTAURADAS
// =================================================================================

function openAddProductModal() {
    // 1. Limpa campos
    ['product-name', 'product-price', 'product-ncm', 'product-cest', 'product-sku', 'editing-product-id'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
    });
    
    // 2. Reseta imagem
    const imgPreview = document.getElementById('product-image-preview');
    if(imgPreview) imgPreview.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-camera"></i><div>Foto</div></div>';

    // 3. Ajusta botﾃｵes
    const btnDelete = document.getElementById('btn-delete-product-modal');
    if(btnDelete) btnDelete.style.display = 'none';

    const title = document.querySelector('#modal-add-product .modal-title');
    if(title) title.textContent = 'Novo Produto';

    // 4. Abre modal
    const modal = document.getElementById('modal-add-product');
    if(modal) {
        modal.classList.add('active');
        modal.style.display = 'flex'; // Forﾃｧa display
    }
}

// Funﾃｧﾃ｣o de salvar (Simulada ou Firebase)
window.saveProduct = function() {
    const nome = document.getElementById('product-name').value;
    if(!nome) {
        alert("Preencha o nome do produto!");
        return;
    }

    // Fecha modal
    const modal = document.getElementById('modal-add-product');
    if(modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // Feedback Visual (Toast)
    const toast = document.createElement('div');
    toast.innerHTML = '<i class="fas fa-check"></i> Produto salvo com sucesso!';
    toast.style.cssText = "position:fixed; top:20px; right:20px; background:#2ecc71; color:white; padding:15px; border-radius:8px; z-index:9999; box-shadow:0 5px 15px rgba(0,0,0,0.2);";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);

    // Se tiver a funﾃｧﾃ｣o de recarregar produtos, chama ela
    if(typeof loadProducts === 'function') loadProducts();
};

// Fecha resultados se clicar fora
document.addEventListener('click', (e) => {
    // Se nﾃ｣o clicou no container NCM e nﾃ｣o clicou no modal da IA
    if (!e.target.closest('.ncm-container') && !e.target.closest('#modal-detalhes-ia')) {
        const results = document.getElementById('name-ncm-results');
        if(results) results.classList.remove('active');
        document.querySelectorAll('.ncm-container').forEach(el => el.classList.remove('searching'));
    }
});

// Forﾃｧar carregamento inicial se necessﾃ｡rio
console.log("Sistema Fiscal Carregado - Modo Proxy Ativo");













// --- RESTAURAﾃﾃグ DAS FUNﾃﾃ髭S DE PRODUTO (Cole isso antes do Cﾃｳdigo Mestre) ---

function openAddProductModal() {
    // Limpa o formulﾃ｡rio usando sua funﾃｧﾃ｣o existente
    if(typeof limparCamposProduto === 'function') limparCamposProduto();
    
    // Garante que nﾃ｣o tem ID de ediﾃｧﾃ｣o (modo criaﾃｧﾃ｣o)
    const editIdInput = document.getElementById('editing-product-id');
    if(editIdInput) editIdInput.value = ''; 
    
    const titleEl = document.querySelector('#modal-add-product .modal-title');
    if(titleEl) titleEl.textContent = 'Novo Produto';
    
    // Esconde botﾃ｣o excluir se existir
    const btnDelete = document.getElementById('btn-delete-product-modal');
    if(btnDelete) btnDelete.style.display = 'none';
    
    // Abre o modal
    if(typeof openModal === 'function') openModal('modal-add-product');
}

function editProduct(id) {
    // Busca o produto na lista carregada
    const product = allProducts.find(p => p.id === id);
    if (!product) return;

    // Preenche os campos
    document.getElementById('editing-product-id').value = product.id;
    document.getElementById('product-name').value = product.name;
    document.getElementById('product-price').value = product.price;
    document.getElementById('product-quantity').value = product.quantity || 0;
    document.getElementById('product-sku').value = product.sku || '';
    document.getElementById('product-ncm').value = product.ncm || '';
    document.getElementById('product-cest').value = product.cest || '';
    
    // Mostra imagem se tiver
    const imgPreview = document.getElementById('product-image-preview');
    const imgInput = document.getElementById('product-image-base64');
    
    if (product.image) {
        if(imgInput) imgInput.value = product.image;
        if(imgPreview) imgPreview.innerHTML = `<img src="${product.image}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">`;
    } else {
        if(imgPreview) imgPreview.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-camera"></i><div>Foto</div></div>';
    }

    document.querySelector('#modal-add-product .modal-title').textContent = 'Editar Produto';
    
    // Botﾃ｣o Excluir (Cria se nﾃ｣o existir)
    let btnDelete = document.getElementById('btn-delete-product-modal');
    if (!btnDelete) {
        const modalBox = document.querySelector('#modal-add-product .modal-box');
        if(modalBox) {
            btnDelete = document.createElement('button');
            btnDelete.id = 'btn-delete-product-modal';
            btnDelete.className = 'btn btn-danger mt-10';
            btnDelete.innerHTML = '<i class="fas fa-trash"></i> Excluir Produto';
            btnDelete.onclick = () => deleteProductFromModal();
            modalBox.appendChild(btnDelete);
        }
    }
    if(btnDelete) btnDelete.style.display = 'block';

    openModal('modal-add-product');
}

// Funﾃｧﾃ｣o de Salvar (Cria ou Edita)
window.saveProduct = function() {
    const editingId = document.getElementById('editing-product-id').value;
    const name = document.getElementById('product-name').value.trim();
    const price = parseFloat(document.getElementById('product-price').value);
    const quantity = parseInt(document.getElementById('product-quantity').value) || 0;
    const sku = document.getElementById('product-sku').value.trim();
    const ncm = document.getElementById('product-ncm').value.trim();
    const cest = document.getElementById('product-cest').value.trim();
    const image = document.getElementById('product-image-base64').value;

    if (!name) { showToast('Atenﾃｧﾃ｣o', 'Nome obrigatﾃｳrio', 'warning'); return; }
    
    const id = editingId || Date.now().toString();
    
    // Objeto do produto
    const productData = { 
        id, name, price, quantity, stock: quantity, sku: sku || id, ncm, cest, image,
        searchKey: name.toLowerCase(), 
        updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
    };
    
    // Salva no Firebase
    if(currentUser) {
        db.collection('users').doc(currentUser.uid).collection('products').doc(id).set(productData, { merge: true })
            .then(() => { 
                closeModal('modal-add-product'); 
                showToast('Sucesso', 'Produto salvo!', 'success');
                if(typeof limparCamposProduto === 'function') limparCamposProduto();
                if(typeof loadProducts === 'function') loadProducts(); 
            })
            .catch(e => showToast('Erro', e.message, 'error'));
    }
};

function deleteProductFromModal() {
    const id = document.getElementById('editing-product-id').value;
    if(confirm("Excluir este produto?")) {
        db.collection('users').doc(currentUser.uid).collection('products').doc(id).delete()
        .then(() => {
            closeModal('modal-add-product');
            showToast('Sucesso', 'Produto excluﾃｭdo', 'success');
            if(typeof loadProducts === 'function') loadProducts();
        });
    }
}


    </script>
</body>
</html>
